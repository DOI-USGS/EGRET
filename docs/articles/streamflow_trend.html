<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Streamflow Trend Analysis • EGRET</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Daily Streamflow Trend Analysis">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EGRET</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/EGRET.html">Introduction</a>
</li>
<li>
  <a href="../reference/index.html">Function Help Pages</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Enhancements.html">Enhancements</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running in Parallel</a>
    </li>
    <li>
      <a href="../articles/rResid.html">Random Residuals</a>
    </li>
    <li>
      <a href="../articles/SeasonalFraction.html">Seasonal Analysis</a>
    </li>
    <li>
      <a href="../articles/streamflow_trend.html">Daily Streamflow Trends</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/References.html">Bibliograpy</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/EGRET">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Daily Streamflow Trend Analysis</h1>
            
            <h4 class="date">2018-05-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/EGRET/blob/master/vignettes/streamflow_trend.Rmd"><code>vignettes/streamflow_trend.Rmd</code></a></small>
      <div class="hidden name"><code>streamflow_trend.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This document describes how to produce a set of graphics and perform the associated statistical tests that describe trends in daily streamflow at a single streamgage. The trends depicted cover the full range of quantiles of the streamflow distribution, from the lowest discharge of the year, through the median discharge, up through the highest discharge of the year. The method is built around the R package <strong>EGRET</strong> <a href="https://CRAN.R-project.org/package=EGRET">Exploration and Graphics for RivEr Trends</a>. It makes it possible to consider trends over any portion of the time period for which there are daily streamflow records, and any period of analysis (the portion of the year to be considered, e.g. the entire year or just the summer months).</p>
</div>
<div id="getting-started" class="section level1">
<h1 class="hasAnchor">
<a href="#getting-started" class="anchor"></a>Getting Started</h1>
<p>First, the <code>EGRET</code> package needs to be installed and loaded. Then, you’ll need need to create an <code>eList</code> object, which contains site information and daily discharge data for streamgage. Page 13 of the EGRET user guide <a href="http://pubs.usgs.gov/tm/04/a10/">here</a>.</p>
<p>For this post, we will use the Choptank River in Maryland as our first example. There is an example data set included in <code>EGRET</code>. The data set consists of site information, daily discharge data, and water quality data, but this application does not use the water quality data. Refer to the section near the end of this document called <strong>Downloading the data for your site of interest</strong> to see how you can set up an eList object for any USGS streamgage.</p>
<p>There are two limitations that users should know about this application before proceeding any further.</p>
<ol style="list-style-type: decimal">
<li><p><strong>The code was designed for discharge records that are complete (no gaps).</strong> This is usually not a problem with USGS discharge records unless there is a major gap (typically years in length) when the streamgage was not operating. If records have a number of small gaps, users could use some established method for filling in missing data to create a gap-free record.</p></li>
<li><p><strong>The discharge on every day should be a positive value (not zero or negative).</strong> The <code>EGRET</code> code that is used here to read in new data has a “work around” for situations where there are a very small number of non-positive discharge values. It adds a small constant to all the discharge data so they will all be positive. This should have almost no impact on the results provided the number of non-positive days is very small, say less than 0.1% of all the days. That translates to about 11 days out of 30 years. For data sets with more zero or negative flow days different code would need to be written (we would appreciate it if an user could work on developing such a set of code).</p></li>
</ol>
<p>To start, the following R commands are needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(EGRET)
eList &lt;-<span class="st"> </span>Choptank_eList</code></pre></div>
<p>Just to get some sense about the data we will look a portion of the metadata (gage ID number, name, and drainage area in square kilometers) and also see a summary of the discharge data (discharge in in cubic meters per second).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(eList<span class="op">$</span>INFO<span class="op">$</span>site.no)</code></pre></div>
<pre><code>## [1] "01491000"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(eList<span class="op">$</span>INFO<span class="op">$</span>shortName)</code></pre></div>
<pre><code>## [1] "Choptank River"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(eList<span class="op">$</span>INFO<span class="op">$</span>drainSqKm)</code></pre></div>
<pre><code>## [1] 292.6687</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(eList<span class="op">$</span>Daily<span class="op">$</span>Date))</code></pre></div>
<pre><code>##         Min.      1st Qu.       Median         Mean      3rd Qu. 
## "1979-10-01" "1987-09-30" "1995-09-30" "1995-09-30" "2003-09-30" 
##         Max. 
## "2011-09-30"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/summary">summary</a></span>(eList<span class="op">$</span>Daily<span class="op">$</span>Q))</code></pre></div>
<pre><code>##      Min.   1st Qu.    Median      Mean   3rd Qu.      Max. 
##   0.00991   0.93446   2.40693   4.08658   4.61565 246.35656</code></pre>
</div>
<div id="loading-the-necessary-packages-and-other-r-code" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-the-necessary-packages-and-other-r-code" class="anchor"></a>Loading the necessary packages and other R code</h1>
<p>To run the analysis and produce the graphs you will need a few R functions in addition to the <code>EGRET</code> package. You can copy the entire block of code shown below here and paste it into your workspace (all as a single copy and paste) or you can create an .R file from the code that you will source each time you want to use it. Let’s say you call it <code>flowTrends.R</code>, then each time you want to use it you need to “source” the object <code>flowTrends.R</code>.</p>
<p>In addition to <code>EGRET</code> the functions use the packages <a href="https://CRAN.R-project.org/package=rkt"><code>rkt</code></a>, <a href="https://CRAN.R-project.org/package=zyp"><code>zyp</code></a>, <a href="https://CRAN.R-project.org/package=lubridate"><code>lubridate</code></a>, and <a href="https://CRAN.R-project.org/package=Kendall"><code>Kendall</code></a>. Make sure you have installed all of them.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(rkt)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(zyp)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)


########## this is the function you will use to make a single trend graph  ##############


plotFlowTrend &lt;-<span class="st"> </span><span class="cf">function</span> (eList, istat, <span class="dt">startDate =</span> <span class="ot">NA</span>, <span class="dt">endDate =</span> <span class="ot">NA</span>, 
                           <span class="dt">paStart =</span> <span class="dv">4</span>, <span class="dt">paLong =</span> <span class="dv">12</span>, <span class="dt">window =</span> <span class="dv">30</span>, <span class="dt">qMax =</span> <span class="ot">NA</span>, 
                           <span class="dt">printTitle =</span> <span class="ot">TRUE</span>, <span class="dt">tinyPlot =</span> <span class="ot">FALSE</span>, 
                           <span class="dt">customPar =</span> <span class="ot">FALSE</span>, <span class="dt">runoff =</span> <span class="ot">FALSE</span>,
                           <span class="dt">qUnit =</span> <span class="dv">2</span>, <span class="dt">printStaName =</span> <span class="ot">TRUE</span>, <span class="dt">printPA =</span> <span class="ot">TRUE</span>,
                           <span class="dt">printIstat =</span> <span class="ot">TRUE</span>, <span class="dt">cex =</span> <span class="fl">0.8</span>, <span class="dt">cex.axis =</span> <span class="fl">1.1</span>,
                           <span class="dt">cex.main =</span> <span class="fl">1.1</span>, <span class="dt">lwd =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">"black"</span>, ...){
  localDaily &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getDaily.html">getDaily</a></span>(eList)
  localINFO &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getInfo.html">getInfo</a></span>(eList)
  localINFO<span class="op">$</span>paStart &lt;-<span class="st"> </span>paStart
  localINFO<span class="op">$</span>paLong &lt;-<span class="st"> </span>paLong
  localINFO<span class="op">$</span>window &lt;-<span class="st"> </span>window
  start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(startDate)
  end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(endDate)
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(startDate)){
    start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="dv">1</span>]) 
  } 
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(endDate)){
    end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(localDaily<span class="op">$</span>Date)])
  }
  
  localDaily &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(localDaily, Date <span class="op">&gt;=</span><span class="st"> </span>start <span class="op">&amp;</span><span class="st"> </span>Date <span class="op">&lt;=</span><span class="st"> </span>end)
  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as.egret.html">as.egret</a></span>(localINFO,localDaily)
  localAnnualSeries &lt;-<span class="st"> </span><span class="kw"><a href="../reference/makeAnnualSeries.html">makeAnnualSeries</a></span>(eList)
  qActual &lt;-<span class="st"> </span>localAnnualSeries[<span class="dv">2</span>, istat, ]
  qSmooth &lt;-<span class="st"> </span>localAnnualSeries[<span class="dv">3</span>, istat, ]
  years &lt;-<span class="st"> </span>localAnnualSeries[<span class="dv">1</span>, istat, ]
  Q &lt;-<span class="st"> </span>qActual
  time &lt;-<span class="st"> </span>years
  LogQ &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(Q)
  mktFrame &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(time,LogQ)
  mktFrame &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/na.fail">na.omit</a></span>(mktFrame)
  mktOut &lt;-<span class="st"> </span>rkt<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rkt/topics/rkt">rkt</a></span>(mktFrame<span class="op">$</span>time,mktFrame<span class="op">$</span>LogQ)
  zypOut &lt;-<span class="st"> </span>zyp<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/zyp/topics/zyp.trend.vector">zyp.zhang</a></span>(mktFrame<span class="op">$</span>LogQ,mktFrame<span class="op">$</span>time)
  slope &lt;-<span class="st"> </span>mktOut<span class="op">$</span>B
  slopePct &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(slope)) <span class="op">-</span><span class="st"> </span><span class="dv">100</span>
  slopePct &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/format">format</a></span>(slopePct,<span class="dt">digits=</span><span class="dv">2</span>)
  pValue &lt;-<span class="st"> </span>zypOut[<span class="dv">6</span>]
  pValue &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/format">format</a></span>(pValue,<span class="dt">digits =</span> <span class="dv">3</span>)
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">is.numeric</a></span>(qUnit)) {
    qUnit &lt;-<span class="st"> </span>qConst[shortCode =<span class="st"> </span>qUnit][[<span class="dv">1</span>]]
  } <span class="cf">else</span> <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">is.character</a></span>(qUnit)) {
    qUnit &lt;-<span class="st"> </span>qConst[qUnit][[<span class="dv">1</span>]]
  }
  
  qFactor &lt;-<span class="st"> </span>qUnit<span class="op">@</span>qUnitFactor
  yLab &lt;-<span class="st"> </span>qUnit<span class="op">@</span>qUnitTiny
  
  <span class="cf">if</span> (runoff) {
    qActual &lt;-<span class="st"> </span>qActual <span class="op">*</span><span class="st"> </span><span class="fl">86.4</span><span class="op">/</span>localINFO<span class="op">$</span>drainSqKm
    qSmooth &lt;-<span class="st"> </span>qSmooth <span class="op">*</span><span class="st"> </span><span class="fl">86.4</span><span class="op">/</span>localINFO<span class="op">$</span>drainSqKm
    yLab &lt;-<span class="st"> "Runoff in mm/day"</span>
  } <span class="cf">else</span> {
    qActual &lt;-<span class="st"> </span>qActual <span class="op">*</span><span class="st"> </span>qFactor
    qSmooth &lt;-<span class="st"> </span>qSmooth <span class="op">*</span><span class="st"> </span>qFactor
  }
  
  localSeries &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(years, qActual, qSmooth)
  
  
  yInfo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generalAxis.html">generalAxis</a></span>(<span class="dt">x =</span> qActual, <span class="dt">maxVal =</span> qMax, <span class="dt">minVal =</span> <span class="dv">0</span>, 
                       <span class="dt">tinyPlot =</span> tinyPlot)
  xInfo &lt;-<span class="st"> </span><span class="kw"><a href="../reference/generalAxis.html">generalAxis</a></span>(<span class="dt">x =</span> localSeries<span class="op">$</span>years, <span class="dt">maxVal =</span> <span class="kw">decimal_date</span>(end), 
                       <span class="dt">minVal =</span> <span class="kw">decimal_date</span>(start), <span class="dt">padPercent =</span> <span class="dv">0</span>, <span class="dt">tinyPlot =</span> tinyPlot)
  
  line1 &lt;-<span class="st"> </span>localINFO<span class="op">$</span>shortName
  nameIstat &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"minimum day"</span>, <span class="st">"7-day minimum"</span>, <span class="st">"30-day minimum"</span>, 
                 <span class="st">"median daily"</span>, <span class="st">"mean daily"</span>, <span class="st">"30-day maximum"</span>, <span class="st">"7-day maximum"</span>, 
                 <span class="st">"maximum day"</span>)
  
  line2 &lt;-<span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, <span class="kw"><a href="../reference/setSeasonLabelByUser.html">setSeasonLabelByUser</a></span>(<span class="dt">paStartInput =</span> paStart, 
                                              <span class="dt">paLongInput =</span> paLong), <span class="st">"  "</span>, nameIstat[istat])
  
  line3 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Slope estimate is "</span>,slopePct,<span class="st">"% per year, Mann-Kendall p-value is "</span>,pValue)
  
  <span class="cf">if</span>(tinyPlot){
    title &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(nameIstat[istat])
  } <span class="cf">else</span> {
    title &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(line1, line2, line3)
  }
  
  <span class="cf">if</span> (<span class="op">!</span>printTitle){
    title &lt;-<span class="st"> ""</span>
  }
  
  <span class="kw"><a href="../reference/genericEGRETDotPlot.html">genericEGRETDotPlot</a></span>(<span class="dt">x =</span> localSeries<span class="op">$</span>years, <span class="dt">y =</span> localSeries<span class="op">$</span>qActual, 
                      <span class="dt">xlim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(xInfo<span class="op">$</span>bottom, xInfo<span class="op">$</span>top), <span class="dt">ylim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(yInfo<span class="op">$</span>bottom, 
                                                                  yInfo<span class="op">$</span>top), <span class="dt">xlab =</span> <span class="st">""</span>, <span class="dt">ylab =</span> yLab, <span class="dt">customPar =</span> customPar, 
                      <span class="dt">xTicks =</span> xInfo<span class="op">$</span>ticks, <span class="dt">yTicks =</span> yInfo<span class="op">$</span>ticks, <span class="dt">cex =</span> cex, 
                      <span class="dt">plotTitle =</span> title, <span class="dt">cex.axis =</span> cex.axis, <span class="dt">cex.main =</span> cex.main, 
                      <span class="dt">tinyPlot =</span> tinyPlot, <span class="dt">lwd =</span> lwd, <span class="dt">col =</span> col, ...)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/lines">lines</a></span>(localSeries<span class="op">$</span>years, localSeries<span class="op">$</span>qSmooth, <span class="dt">lwd =</span> lwd, 
        <span class="dt">col =</span> col)
}

#########################################################################################
###### this the the function you will use to make the Quantile Kendall Plot #############
#########################################################################################

plotQuantileKendall &lt;-<span class="st"> </span><span class="cf">function</span>(eList, <span class="dt">startDate =</span> <span class="ot">NA</span>, <span class="dt">endDate =</span> <span class="ot">NA</span>, 
                      <span class="dt">paStart =</span> <span class="dv">4</span>, <span class="dt">paLong =</span> <span class="dv">12</span>,     
                      <span class="dt">legendLocation =</span> <span class="st">"topleft"</span>, <span class="dt">legendSize =</span> <span class="fl">1.0</span>,
                      <span class="dt">yMax =</span> <span class="ot">NA</span>, <span class="dt">yMin =</span> <span class="ot">NA</span>) {
  localDaily &lt;-<span class="st"> </span>eList<span class="op">$</span>Daily
  localINFO &lt;-<span class="st"> </span>eList<span class="op">$</span>INFO
  localINFO<span class="op">$</span>paStart &lt;-<span class="st"> </span>paStart
  localINFO<span class="op">$</span>paLong &lt;-<span class="st"> </span>paLong
  start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(startDate)
  end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(endDate)
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(startDate)){
    start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="dv">1</span>]) 
  } 
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(endDate)){
    end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(localDaily<span class="op">$</span>Date)])
  }
  
  localDaily &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(localDaily, Date <span class="op">&gt;=</span><span class="st"> </span>start <span class="op">&amp;</span><span class="st"> </span>Date <span class="op">&lt;=</span><span class="st"> </span>end)
  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as.egret.html">as.egret</a></span>(localINFO,localDaily)
  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setPA.html">setPA</a></span>(eList, <span class="dt">paStart=</span>paStart, <span class="dt">paLong=</span>paLong)
  
  v &lt;-<span class="st"> </span><span class="kw">makeSortQ</span>(eList)
  sortQ &lt;-<span class="st"> </span>v[[<span class="dv">1</span>]]
  time &lt;-<span class="st"> </span>v[[<span class="dv">2</span>]]
  results &lt;-<span class="st"> </span><span class="kw">trendSortQ</span>(sortQ, time)
  pvals &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>,<span class="fl">0.999</span>)
  zvals &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(pvals)
  name &lt;-<span class="st"> </span>eList<span class="op">$</span>INFO<span class="op">$</span>shortName
<span class="co">#  ymax &lt;- trunc(max(results$slopePct)*10)</span>
<span class="co">#  ymax &lt;- max(ymax + 2, 5)</span>
<span class="co">#  ymin &lt;- floor(min(results$slopePct)*10)</span>
<span class="co">#  ymin &lt;- min(ymin - 2, -5)</span>
<span class="co">#  yrange &lt;- c(ymin/10, ymax/10)</span>
<span class="co">#  yticks &lt;- axisTicks(yrange, log = FALSE)</span>
  ymax &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(results<span class="op">$</span>slopePct <span class="op">+</span><span class="st"> </span><span class="fl">0.5</span>, yMax, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  ymin &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(results<span class="op">$</span>slopePct <span class="op">-</span><span class="st"> </span><span class="fl">0.5</span>, yMin, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  yrange &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(ymin, ymax)
  yticks &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/axisTicks">axisTicks</a></span>(yrange, <span class="dt">log =</span> <span class="ot">FALSE</span>, <span class="dt">nint =</span><span class="dv">7</span>)
  p &lt;-<span class="st"> </span>results<span class="op">$</span>pValueAdj
  color &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(p <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.1</span>,<span class="st">"black"</span>,<span class="st">"snow3"</span>)
  color &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(p <span class="op">&lt;</span><span class="st"> </span><span class="fl">0.05</span>, <span class="st">"red"</span>, color)
  pvals &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.001</span>,<span class="fl">0.01</span>,<span class="fl">0.05</span>,<span class="fl">0.1</span>,<span class="fl">0.25</span>,<span class="fl">0.5</span>,<span class="fl">0.75</span>,<span class="fl">0.9</span>,<span class="fl">0.95</span>,<span class="fl">0.99</span>,<span class="fl">0.999</span>)
  zvals &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(pvals)
  name &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, eList<span class="op">$</span>INFO<span class="op">$</span>shortName,<span class="st">"</span><span class="ch">\n</span><span class="st">"</span>,
                 start,<span class="st">" through "</span>, end, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, 
                 <span class="kw"><a href="../reference/setSeasonLabelByUser.html">setSeasonLabelByUser</a></span>(<span class="dt">paStartInput =</span> paStart, <span class="dt">paLongInput =</span> paLong))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/plot">plot</a></span>(results<span class="op">$</span>z,results<span class="op">$</span>slopePct,<span class="dt">col =</span> color, <span class="dt">pch =</span> <span class="dv">20</span>, <span class="dt">cex =</span> <span class="fl">1.0</span>, 
       <span class="dt">xlab =</span> <span class="st">"Daily non-exceedance probability"</span>, 
       <span class="dt">ylab =</span> <span class="st">"Trend slope in percent per year"</span>, 
       <span class="dt">xlim =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="fl">3.2</span>, <span class="fl">3.2</span>), <span class="dt">ylim =</span> yrange, <span class="dt">yaxs =</span> <span class="st">"i"</span>, 
       <span class="dt">las =</span> <span class="dv">1</span>, <span class="dt">tck =</span> <span class="fl">0.02</span>, <span class="dt">cex.lab =</span> <span class="fl">1.2</span>, <span class="dt">cex.axis =</span> <span class="fl">1.2</span>, 
       <span class="dt">axes =</span> <span class="ot">FALSE</span>, <span class="dt">frame.plot=</span><span class="ot">TRUE</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/mtext">mtext</a></span>(name, <span class="dt">side =</span><span class="dv">3</span>, <span class="dt">line =</span> <span class="fl">0.2</span>, <span class="dt">cex =</span> <span class="fl">1.2</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/axis">axis</a></span>(<span class="dv">1</span>,<span class="dt">at=</span>zvals,<span class="dt">labels=</span>pvals, <span class="dt">las =</span> <span class="dv">1</span>, <span class="dt">tck =</span> <span class="fl">0.02</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/axis">axis</a></span>(<span class="dv">2</span>,<span class="dt">at=</span>yticks,<span class="dt">labels =</span> <span class="ot">TRUE</span>, <span class="dt">las =</span> <span class="dv">1</span>, <span class="dt">tck =</span> <span class="fl">0.02</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/axis">axis</a></span>(<span class="dv">3</span>,<span class="dt">at=</span>zvals,<span class="dt">labels=</span><span class="ot">FALSE</span>, <span class="dt">las =</span> <span class="dv">1</span>, <span class="dt">tck=</span><span class="fl">0.02</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/axis">axis</a></span>(<span class="dv">4</span>,<span class="dt">at=</span>yticks,<span class="dt">labels =</span> <span class="ot">FALSE</span>, <span class="dt">tick =</span> <span class="ot">TRUE</span>, <span class="dt">tck =</span> <span class="fl">0.02</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/abline">abline</a></span>(<span class="dt">h=</span><span class="dv">0</span>,<span class="dt">col=</span><span class="st">"blue"</span>)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/legend">legend</a></span>(legendLocation,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"&gt; 0.1"</span>,<span class="st">"0.05 - 0.1"</span>,<span class="st">"&lt; 0.05"</span>),<span class="dt">col =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"snow3"</span>,                                            <span class="st">"black"</span>,<span class="st">"red"</span>),<span class="dt">pch =</span> <span class="dv">20</span>, <span class="dt">title =</span> <span class="st">"p-value"</span>,
         <span class="dt">pt.cex=</span><span class="fl">1.0</span>, <span class="dt">cex =</span> legendSize <span class="op">*</span><span class="st"> </span><span class="fl">1.5</span>)
}    

#########################################################################################
############  This next function combines four individual trend graphs (for mimimum day,
########### median day, mean day, and maximum day) along with the quantile kendall graph
#########################################################################################

plotFiveTrendGraphs &lt;-<span class="st"> </span><span class="cf">function</span>(eList, <span class="dt">startDate =</span> <span class="ot">NA</span>, <span class="dt">endDate =</span> <span class="ot">NA</span>, 
                                <span class="dt">paStart =</span> <span class="dv">4</span>, <span class="dt">paLong =</span> <span class="dv">12</span>, <span class="dt">qUnit =</span> <span class="dv">2</span>, <span class="dt">window =</span> <span class="dv">30</span>, 
                                <span class="dt">legendLocation =</span> <span class="st">"topleft"</span>, <span class="dt">legendSize =</span> <span class="fl">1.0</span>) {
  localDaily &lt;-<span class="st"> </span>eList<span class="op">$</span>Daily
  localINFO &lt;-<span class="st"> </span>eList<span class="op">$</span>INFO
  localINFO<span class="op">$</span>paStart &lt;-<span class="st"> </span>paStart
  localINFO<span class="op">$</span>paLong &lt;-<span class="st"> </span>paLong
  localINFO<span class="op">$</span>window &lt;-<span class="st"> </span>window
  
  start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(startDate)
  end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(endDate)
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(startDate)){
    start &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="dv">1</span>]) 
  } 
  
  <span class="cf">if</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(endDate)){
    end &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(localDaily<span class="op">$</span>Date[<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(localDaily<span class="op">$</span>Date)])
  }
  
  localDaily &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(localDaily, Date <span class="op">&gt;=</span><span class="st"> </span>start <span class="op">&amp;</span><span class="st"> </span>Date <span class="op">&lt;=</span><span class="st"> </span>end)
  
  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as.egret.html">as.egret</a></span>(localINFO,localDaily)
  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/setPA.html">setPA</a></span>(eList, <span class="dt">paStart=</span>paStart, <span class="dt">paLong=</span>paLong, <span class="dt">window=</span>window)
  <span class="co"># this next line of code is inserted so that when paLong = 12, we always use the</span>
  <span class="co"># climate year when looking at the trends in the annual minimum flow</span>
  paStart1 &lt;-<span class="st"> </span><span class="cf">if</span>(paLong <span class="op">==</span><span class="st"> </span><span class="dv">12</span>)  <span class="dv">4</span> <span class="cf">else</span> paStart
  <span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">1</span>, <span class="dt">qUnit =</span> qUnit, <span class="dt">paStart =</span> paStart1, <span class="dt">paLong =</span> paLong, <span class="dt">window =</span> window)
  <span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">4</span>, <span class="dt">qUnit =</span> qUnit, <span class="dt">paStart =</span> paStart, <span class="dt">paLong =</span> paLong, <span class="dt">window =</span> window)
  <span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">8</span>, <span class="dt">qUnit =</span> qUnit, <span class="dt">paStart =</span> paStart, <span class="dt">paLong =</span> paLong, <span class="dt">window =</span> window)
  <span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">5</span>, <span class="dt">qUnit =</span> qUnit, <span class="dt">paStart =</span> paStart, <span class="dt">paLong =</span> paLong, <span class="dt">window =</span> window)
  <span class="co"># now the quantile kendall</span>
  <span class="kw">plotQuantileKendall</span>(eList, <span class="dt">startDate =</span> startDate, <span class="dt">endDate =</span> endDate, <span class="dt">paStart =</span> paStart,
                      <span class="dt">paLong =</span> paLong, <span class="dt">legendLocation =</span> legendLocation, <span class="dt">legendSize =</span> legendSize)
  
} 

#########################################################################################
########### makeSortQ creates a matrix called Qsort. 
############It sorted from smallest to largest over dimDays 
############(if working with full year dimDays=365), 
#############and also creates other vectors that contain information about this array.
#########################################################################################

makeSortQ &lt;-<span class="st"> </span><span class="cf">function</span>(eList){
  localINFO &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getInfo.html">getInfo</a></span>(eList)
  localDaily &lt;-<span class="st"> </span><span class="kw"><a href="../reference/getDaily.html">getDaily</a></span>(eList)
  paStart &lt;-<span class="st"> </span>localINFO<span class="op">$</span>paStart
  paLong &lt;-<span class="st"> </span>localINFO<span class="op">$</span>paLong
  <span class="co"># determine the maximum number of days to put in the array</span>
  numDays &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(localDaily<span class="op">$</span>DecYear)
  monthSeqFirst &lt;-<span class="st"> </span>localDaily<span class="op">$</span>MonthSeq[<span class="dv">1</span>]
  monthSeqLast &lt;-<span class="st"> </span>localDaily<span class="op">$</span>MonthSeq[numDays]
  <span class="co"># creating a data frame (called startEndSeq) of the MonthSeq values that go into each year</span>
  Starts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(paStart, monthSeqLast, <span class="dv">12</span>)
  Ends &lt;-<span class="st"> </span>Starts <span class="op">+</span><span class="st"> </span>paLong <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  startEndSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(Starts, Ends)
  <span class="co"># trim this list of Starts and Ends to fit the period of record</span>
  startEndSeq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/subset">subset</a></span>(startEndSeq, Ends <span class="op">&gt;=</span><span class="st"> </span>monthSeqFirst <span class="op">&amp;</span><span class="st"> </span>Starts <span class="op">&lt;=</span><span class="st"> </span>monthSeqLast)
  numYearsRaw &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(startEndSeq<span class="op">$</span>Ends)
  <span class="co"># set up some vectors to keep track of years</span>
  good &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, numYearsRaw)
  numDays &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, numYearsRaw)
  midDecYear &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>, numYearsRaw)
  Qraw &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">nrow =</span> <span class="dv">366</span>, <span class="dt">ncol =</span> numYearsRaw)
  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="st"> </span>numYearsRaw) {
    startSeq &lt;-<span class="st"> </span>startEndSeq<span class="op">$</span>Starts[i]
    endSeq &lt;-<span class="st"> </span>startEndSeq<span class="op">$</span>Ends[i]
    startJulian &lt;-<span class="st"> </span><span class="kw">getFirstJulian</span>(startSeq)
    <span class="co"># startJulian is the first julian day of the first month in the year being processed</span>
    <span class="co"># endJulian is the first julian day of the month right after the last month in the year being processed</span>
    endJulian &lt;-<span class="st"> </span><span class="kw">getFirstJulian</span>(endSeq <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
    fullDuration &lt;-<span class="st"> </span>endJulian <span class="op">-</span><span class="st"> </span>startJulian
    yearDaily &lt;-<span class="st"> </span>localDaily[localDaily<span class="op">$</span>MonthSeq <span class="op">&gt;=</span><span class="st"> </span>startSeq <span class="op">&amp;</span><span class="st"> </span>(localDaily<span class="op">$</span>MonthSeq <span class="op">&lt;=</span><span class="st"> </span>endSeq), ]
    nDays &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(yearDaily<span class="op">$</span>Q)
    <span class="cf">if</span>(nDays <span class="op">==</span><span class="st"> </span>fullDuration) {
      good[i] &lt;-<span class="st"> </span><span class="dv">1</span>
      numDays[i] &lt;-<span class="st"> </span>nDays
      midDecYear[i] &lt;-<span class="st"> </span>(yearDaily<span class="op">$</span>DecYear[<span class="dv">1</span>] <span class="op">+</span><span class="st"> </span>yearDaily<span class="op">$</span>DecYear[nDays]) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>
      Qraw[<span class="dv">1</span><span class="op">:</span>nDays,i] &lt;-<span class="st"> </span>yearDaily<span class="op">$</span>Q
    }   <span class="cf">else</span> {
      numDays[i] &lt;-<span class="st"> </span><span class="ot">NA</span>
      midDecYear[i] &lt;-<span class="st"> </span><span class="ot">NA</span>
    }
  }
  <span class="co"># now we compress the matrix down to equal number of values in each column</span>
  j &lt;-<span class="st"> </span><span class="dv">0</span>
  numGoodYears &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(good)
  dayCounts &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(good<span class="op">==</span><span class="dv">1</span>, numDays, <span class="ot">NA</span>)
  lowDays &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>(dayCounts, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  highDays &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(dayCounts, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  dimYears &lt;-<span class="st"> </span>numGoodYears
  dimDays &lt;-<span class="st"> </span>lowDays
  sortQ &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">nrow =</span> dimDays, <span class="dt">ncol =</span> dimYears)
  time &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,dimYears)
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>numYearsRaw){
    <span class="cf">if</span>(good[i]<span class="op">==</span><span class="dv">1</span>) {
      j &lt;-<span class="st"> </span>j <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
      numD &lt;-<span class="st"> </span>numDays[i]
      x &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sort">sort</a></span>(Qraw[<span class="dv">1</span><span class="op">:</span>numD, i])
      <span class="co"># separate odd numbers from even numbers of days</span>
      <span class="cf">if</span>(numD <span class="op">==</span><span class="st"> </span>lowDays) {
        sortQ[<span class="dv">1</span><span class="op">:</span>dimDays,j] &lt;-<span class="st"> </span>x
      } <span class="cf">else</span> {
        sortQ[<span class="dv">1</span><span class="op">:</span>dimDays,j] &lt;-<span class="st"> </span><span class="cf">if</span>(<span class="kw">odd</span>(numD)) <span class="kw">leapOdd</span>(x) <span class="cf">else</span> <span class="kw">leapEven</span>(x)
      }
      time[j] &lt;-<span class="st"> </span>midDecYear[i]
    } 
  }
  
  sortQList =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(sortQ,time)
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(sortQList)         
}
#########################################################################################
########## Another function trendSortQ needed for Quantile Kendall
#########################################################################################

trendSortQ &lt;-<span class="st"> </span><span class="cf">function</span>(Qsort, time){
  <span class="co"># note requires packages zyp and rkt</span>
  nFreq &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/dim">dim</a></span>(Qsort)[<span class="dv">1</span>]
  nYears &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(time)
  results &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.data.frame">as.data.frame</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/matrix">matrix</a></span>(<span class="dt">ncol=</span><span class="dv">9</span>,<span class="dt">nrow=</span>nFreq))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/colnames">colnames</a></span>(results) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"slopeLog"</span>,<span class="st">"slopePct"</span>,<span class="st">"pValue"</span>,<span class="st">"pValueAdj"</span>,<span class="st">"tau"</span>,<span class="st">"rho1"</span>,<span class="st">"rho2"</span>,<span class="st">"freq"</span>,<span class="st">"z"</span>)
  <span class="cf">for</span>(iRank <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>nFreq){
    mkOut &lt;-<span class="st"> </span>rkt<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/rkt/topics/rkt">rkt</a></span>(time,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(Qsort[iRank,]))
    results<span class="op">$</span>slopeLog[iRank] &lt;-<span class="st"> </span>mkOut<span class="op">$</span>B
    results<span class="op">$</span>slopePct[iRank] &lt;-<span class="st"> </span><span class="dv">100</span> <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">exp</a></span>(mkOut<span class="op">$</span>B) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)
    results<span class="op">$</span>pValue[iRank] &lt;-<span class="st"> </span>mkOut<span class="op">$</span>sl
    outZYP &lt;-<span class="st"> </span><span class="kw">zyp.zhang</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(Qsort[iRank,]),time)
    results<span class="op">$</span>pValueAdj[iRank] &lt;-<span class="st"> </span>outZYP[<span class="dv">6</span>]
    results<span class="op">$</span>tau[iRank] &lt;-<span class="st"> </span>mkOut<span class="op">$</span>tau
    <span class="co"># I don't actually use this information in the current outputs, but the code is there </span>
    <span class="co"># if one wanted to look at the serial correlation structure of the flow series      </span>
    serial &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/acf">acf</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Log">log</a></span>(Qsort[iRank,]), <span class="dt">lag.max =</span> <span class="dv">2</span>, <span class="dt">plot =</span> <span class="ot">FALSE</span>)
    results<span class="op">$</span>rho1[iRank] &lt;-<span class="st"> </span>serial<span class="op">$</span>acf[<span class="dv">2</span>]
    results<span class="op">$</span>rho2[iRank] &lt;-<span class="st"> </span>serial<span class="op">$</span>acf[<span class="dv">3</span>]
    frequency &lt;-<span class="st"> </span>iRank <span class="op">/</span><span class="st"> </span>(nFreq <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)
    results<span class="op">$</span>freq[iRank] &lt;-<span class="st"> </span>frequency
    results<span class="op">$</span>z[iRank] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Normal">qnorm</a></span>(frequency)    
  }
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(results)
}
#########################################################################################
################################## getFirstJulian finds the julian date of first day
################################## of a given month
#########################################################################################

getFirstJulian &lt;-<span class="st"> </span><span class="cf">function</span>(monthSeq){
  year &lt;-<span class="st"> </span><span class="dv">1850</span> <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">trunc</a></span>((monthSeq <span class="op">-</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">12</span>)
  month &lt;-<span class="st"> </span>monthSeq <span class="op">-</span><span class="st"> </span><span class="dv">12</span> <span class="op">*</span><span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Round">trunc</a></span>((monthSeq<span class="op">-</span><span class="dv">1</span>)<span class="op">/</span><span class="dv">12</span>))
  charMonth &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(month<span class="op">&lt;</span><span class="dv">10</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"0"</span>,<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(month)), <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">as.character</a></span>(month))
  theDate &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(year,<span class="st">"-"</span>,charMonth,<span class="st">"-01"</span>)
  Julian1 &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/numeric">as.numeric</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/weekday.POSIXt">julian</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(theDate),<span class="dt">origin=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/as.Date">as.Date</a></span>(<span class="st">"1850-01-01"</span>)))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(Julian1)
}

#########################################################################################
########### leapOdd  is a function for deleting one value 
############when the period that contains Februaries has a length that is an odd number
#########################################################################################

leapOdd &lt;-<span class="st"> </span><span class="cf">function</span>(x){
  n &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(x)
  m &lt;-<span class="st"> </span>n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  mid &lt;-<span class="st"> </span>(n <span class="op">+</span><span class="st"> </span><span class="dv">1</span>) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>
  mid1 &lt;-<span class="st"> </span>mid <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  midMinus &lt;-<span class="st"> </span>mid <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, m)
  y[<span class="dv">1</span><span class="op">:</span>midMinus] &lt;-<span class="st"> </span>x[<span class="dv">1</span><span class="op">:</span>midMinus]
  y[mid<span class="op">:</span>m] &lt;-<span class="st"> </span>x[mid1<span class="op">:</span>n]
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(y)}

#########################################################################################
########### leapEven  is a function for deleting one value 
############when the period that contains Februaries has a length that is an even number
#########################################################################################

leapEven &lt;-<span class="st"> </span><span class="cf">function</span>(x){
  n &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(x)
  m &lt;-<span class="st"> </span>n <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  mid &lt;-<span class="st"> </span>n <span class="op">/</span><span class="st"> </span><span class="dv">2</span>
  y &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="ot">NA</span>, m)
  mid1 &lt;-<span class="st"> </span>mid <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  mid2 &lt;-<span class="st"> </span>mid <span class="op">+</span><span class="st"> </span><span class="dv">2</span>
  midMinus &lt;-<span class="st"> </span>mid <span class="op">-</span><span class="st"> </span><span class="dv">1</span>
  y[<span class="dv">1</span><span class="op">:</span>midMinus] &lt;-<span class="st"> </span>x[<span class="dv">1</span><span class="op">:</span>midMinus]
  y[mid] &lt;-<span class="st"> </span>(x[mid] <span class="op">+</span><span class="st"> </span>x[mid1]) <span class="op">/</span><span class="st"> </span><span class="dv">2</span>
  y[mid1<span class="op">:</span>m] &lt;-<span class="st"> </span>x[mid2 <span class="op">:</span><span class="st"> </span>n]
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(y)
}

#########################################################################################
####### determines if the length of a vector is an odd number ###########################
#########################################################################################

odd &lt;-<span class="st"> </span><span class="cf">function</span>(x) {(<span class="op">!</span>(x <span class="op">%%</span><span class="st"> </span><span class="dv">2</span>) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)}

#########################################################################################
########### calcWY calculates the water year and inserts it into a data frame
#########################################################################################


calcWY &lt;-<span class="st"> </span><span class="cf">function</span> (df) {
  df<span class="op">$</span>WaterYear &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(df<span class="op">$</span>DecYear)
  df<span class="op">$</span>WaterYear[df<span class="op">$</span>Month <span class="op">&gt;=</span><span class="st"> </span><span class="dv">10</span>] &lt;-<span class="st"> </span>df<span class="op">$</span>WaterYear[df<span class="op">$</span>Month <span class="op">&gt;=</span><span class="st"> </span>
<span class="st">                                                 </span><span class="dv">10</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(df)
}
#########################################################################################
##### calcCY calculates the climate year and inserts it into a data frame
#########################################################################################

calcCY &lt;-<span class="st"> </span><span class="cf">function</span> (df){
  df<span class="op">$</span>ClimateYear &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(df<span class="op">$</span>DecYear)
  df<span class="op">$</span>ClimateYear[df<span class="op">$</span>Month <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>] &lt;-<span class="st"> </span>df<span class="op">$</span>ClimateYear[df<span class="op">$</span>Month <span class="op">&gt;=</span><span class="st"> </span>
<span class="st">                                                    </span><span class="dv">4</span>] <span class="op">+</span><span class="st"> </span><span class="dv">1</span>
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(df)
}
#########################################################################################
######## smoother is a function does the trend in real discharge units and not logs. 
######## It is placed here so that users wanting to run this alternative have it available
######## but it is not actually called by any function in this document
#########################################################################################

smoother &lt;-<span class="st"> </span><span class="cf">function</span>(xy, window){
  edgeAdjust &lt;-<span class="st"> </span><span class="ot">TRUE</span>
  x &lt;-<span class="st"> </span>xy<span class="op">$</span>x
  y &lt;-<span class="st"> </span>xy<span class="op">$</span>y
  n &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(y)
  z &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rep">rep</a></span>(<span class="dv">0</span>,n)
  x1 &lt;-<span class="st"> </span>x[<span class="dv">1</span>]
  xn &lt;-<span class="st"> </span>x[n]
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span>n) {
    xi &lt;-<span class="st"> </span>x[i]
    distToEdge &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">min</a></span>((xi <span class="op">-</span><span class="st"> </span>x1), (xn <span class="op">-</span><span class="st"> </span>xi))
    close &lt;-<span class="st"> </span>(distToEdge <span class="op">&lt;</span><span class="st"> </span>window)
    thisWindow &lt;-<span class="st"> </span><span class="cf">if</span> (edgeAdjust <span class="op">&amp;</span><span class="st"> </span>close) 
      (<span class="dv">2</span> <span class="op">*</span><span class="st"> </span>window) <span class="op">-</span><span class="st"> </span>distToEdge
    <span class="cf">else</span> window
    w &lt;-<span class="st"> </span><span class="kw"><a href="../reference/triCube.html">triCube</a></span>(x <span class="op">-</span><span class="st"> </span>xi, thisWindow)
    mod &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(xy<span class="op">$</span>y <span class="op">~</span><span class="st"> </span>x, <span class="dt">weights =</span> w)
    new &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/data.frame">data.frame</a></span>(<span class="dt">x =</span> x[i])
    z[i] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/predict">predict</a></span>(mod, new)
  }
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(z)
}</code></pre></div>
</div>
<div id="making-a-graph-of-the-trend-in-a-single-flow-statistic" class="section level1">
<h1 class="hasAnchor">
<a href="#making-a-graph-of-the-trend-in-a-single-flow-statistic" class="anchor"></a>Making a graph of the trend in a single flow statistic</h1>
<p>Now all we need to do is to run the <strong>plotFlowTrend</strong> function that was the first part of the code we just read in. First we will run it in its simplest form, we will use the entire discharge record and our period of analysis will be the full <strong>climatic year</strong>. A climatic year is the year that starts on April 1 and ends on March 31. It is our default approach because it tends to avoid breaking a long-low flow period into two segments, one in each of two adjacent years. We will first run it for the annual minimum daily discharge.</p>
<p>To use it you will need to know about the index of flow statistics used in EGRET. They are called <strong>istat</strong> and the statistics represented by <strong>istat</strong> are: (1) 1-day minimum, (2) 7-day minimum, (3) 30-day minimum, (4) median (5) mean, (6) 30-day maximum, (7) 7-day maximum, and (8) 1-day maximum. So to run the annual minimum daily discharge statistic we would set <strong>istat = 1</strong>. To run the <strong>plotFlowTrend</strong> function it in its simplest form the only arguments we need are the eList (which contains the metadata and the discharge data), and istat.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">1</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-4-1.png" alt="Discharge as a function of Year, slope estimates -0.5% and Mann-Kendall p-value 0.785" width="700"><p class="caption">
Discharge as a function of Year, slope estimates -0.5% and Mann-Kendall p-value 0.785
</p>
</div>
<div id="explanation-of-the-flowtrend-plot-annual-minimum-day" class="section level2">
<h2 class="hasAnchor">
<a href="#explanation-of-the-flowtrend-plot-annual-minimum-day" class="anchor"></a>Explanation of the FlowTrend Plot, annual minimum day</h2>
<p>The dots indicate the discharge on the minimum day of each climate year in the period of record. The solid curve is a smoothed representation of those data. It is specifically the smoother that is defined in the EGRET user guide (pages 16-18) with a 30-year window. For record as short as this one (only 32 years) it will typically look like a straight line or a very smooth curve. For longer records it can display some substantial changes in slope and even be non-monotonic. At the top of the graph we see two pieces of information. A trend slope expressed in percent per year and a p-value for the Mann-Kendall trend test of the data. The slope is computed using the Thiel-Sen slope estimator. It is discussed on pages 266-274 of Helsel and Hirsch, 2002, which can be found <a href="https://pubs.usgs.gov/twri/twri4a3/">here</a> although it is called the “Kendall-Theil Robust Line” in that text. It is calculated on the logarithms of the discharge data and then transformed to express the trend in percent per year. The p-value for the Mann-Kendall test is computed using the adjustment for serial correlation introduced in the zyp R package (David Bronaugh and Arelia Werner for the Pacific Climate Impacts Consortium (2013). zyp: Zhang + Yue-Pilon trends package. R package version 0.10-1. <a href="https://CRAN.R-project.org/package=zyp" class="uri">https://CRAN.R-project.org/package=zyp</a>).</p>
</div>
</div>
<div id="a-few-more-flowtrend-plots" class="section level1">
<h1 class="hasAnchor">
<a href="#a-few-more-flowtrend-plots" class="anchor"></a>A few more FlowTrend Plots</h1>
<p>We can do some other similar plots. In this case we will do the annual median day <strong>istat = 4</strong>, the annual maximum day <strong>istat = 8</strong>, and the annual mean day <strong>istat = 5</strong>.</p>
<div id="the-annual-median-day" class="section level2">
<h2 class="hasAnchor">
<a href="#the-annual-median-day" class="anchor"></a>The annual median day</h2>
<p>The median day is computed for each year in the record.It is the middle day, that is 182 values had discharges lower than it and 182 values had discharges greater than it (for a leap year it is the average of the 183rd and 184th ranked values). Everything else about it is the same as the first plot. Here is the annual median day discharge record.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">4</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-5-1.png" alt="Discharge as a function of Year annual median day" width="700"><p class="caption">
Discharge as a function of Year annual median day
</p>
</div>
</div>
<div id="the-annual-maximum-day" class="section level2">
<h2 class="hasAnchor">
<a href="#the-annual-maximum-day" class="anchor"></a>The annual maximum day</h2>
<p>The third plot is for the <em>maximum day</em> of the year. Otherwise it is exactly the same in its construction as the first two plots. Note that this is the maximum daily average discharge and in general it will be smaller than the annual peak discharge, which is the maximum instantaneous discharge for the year, whereas this is the highest daily average discharge. For very large rivers the annual maximum day discharge tends to be very close to the annual peak discharge and can serve as a rough surrogate for it in a trend study. For a small stream, where discharges may rise or fall by a factor of 2 or more in the course of a day, these maximimum day values can be very different from the annual peak discharge.</p>
<p>At this point we will add one more concept, which is the period of analysis. In the first two plots the data were organized by <strong>climate year</strong>. But, when we look at annual maximum or annual mean discharge the standard approach is to use the water year. To do this we need to designate that we want our <strong>period of analysis</strong> to start with the month of October (month 10). To do this we need to add one more argument to our call to the function. <strong>paStart = 10</strong>. We did not need to specify the <strong>paStart</strong> in the first two plots, because the default is <strong>paStart = 4.</strong> Notice that this change in the period of analysis is noted in the text on the graphic.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">8</span>, <span class="dt">paStart =</span> <span class="dv">10</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-6-1.png" alt="Discharge as a function of Year annual maximum day" width="700"><p class="caption">
Discharge as a function of Year annual maximum day
</p>
</div>
<p>The fourth plot is the <em>annual mean discharge</em>. It is constructed in exactly the same manner as the previous three, but it represents the mean streamflow for all of the days in the year rather than a single order statistic such as minimum, median, or maximum. We will also use the water year for this analysis.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">5</span>, <span class="dt">paStart =</span> <span class="dv">10</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-7-1.png" alt="Discharge as a function of Year annual mean discharge" width="700"><p class="caption">
Discharge as a function of Year annual mean discharge
</p>
</div>
</div>
</div>
<div id="some-observations-about-these-figures" class="section level1">
<h1 class="hasAnchor">
<a href="#some-observations-about-these-figures" class="anchor"></a>Some observations about these figures</h1>
<p>It is interesting to note that the minimum discharge values have been trending downwards, although not a statistically significant trend. The other three discharge statistics are all trending upwards and this is most notable in terms of the annual maximum daily discharge, both in terms of slope +4.7% per year, and a p-value that is well below 0.001. This raises many questions about how the variability of discharge might be changing over time and what the drivers are of the trends that are happening in various parts of the probability distribution of discharge (which we commonly call the <strong>flow duration curve</strong>). We will turn our focus to a way of summarizing these changes after we look at a few more variations on this plotFlowTrend graphic.</p>
</div>
<div id="variations-on-the-simplest-example" class="section level1">
<h1 class="hasAnchor">
<a href="#variations-on-the-simplest-example" class="anchor"></a>Variations on the simplest example</h1>
<p>The call to the function <strong>plotFlowTrend</strong> has many arguments (you can see them all in the code shown above) but here we will just focus on a few that may be most useful to the data analyst:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">  <span class="kw">plotFlowTrend</span>(eList, istat, <span class="dt">startDate =</span> <span class="ot">NA</span>, <span class="dt">endDate =</span> <span class="ot">NA</span>, <span class="dt">paStart =</span> <span class="dv">4</span>, <span class="dt">paLong =</span> <span class="dv">12</span>, <span class="dt">window =</span> <span class="dv">30</span>, <span class="dt">qMax =</span> <span class="ot">NA</span>, <span class="dt">qUnit =</span> <span class="dv">2</span>, <span class="dt">runoff =</span> <span class="ot">FALSE</span>)</code></pre></div>
<p>Here is a list of the optional arguments that are available to the user.</p>
<p><strong>startDate</strong> If we want to evaluate the trend for a shorter period than what is contained in the entire Daily data frame, then we can specify a different starting date. For example, if we wanted the analysis to start with Water Year 1981, then we would say: startDate = “1980-10-01”. By leaving out the startDate argment we are requesting the analysis to start where the data starts (which in this case is 1979-10-01).</p>
<p><strong>endDate</strong> If we want to evalute the trend for a period that ends before the end of the data set we can specify that with endDate. So if we wanted to end with Water Year 2009 we would say: endDate = “2009-09-30”.</p>
<p><strong>paStart</strong> is the starting month of the period of analysis. For example if we were interested in the trends in streamflow in a series of months starting with August, we would say paStart = 8. The default is paStart = 4, which starts in April.</p>
<p><strong>paLong</strong> is the duration of the period of analysis. So, an analysis that covers all 12 months would have paLong = 12 (the default). A period that runs for the months of August - November would have paStart = 8 and paLong = 4. See pages 14 and 15 of the user guide for more detail on paStart and paLong.</p>
<p><strong>window</strong> The smoothness of the curve plotted depends on the size of the window (which is measured in years). If <strong>window</strong> were much smaller (say 10) then the curve shown would be rather jagged, and as it becomes longer it causes the curve to converge to a straight line. The default value of 30 works well and is also roughly consistant with the convention used in the climate science community, when they discuss a 30-year normal period. The precise meaning of <strong>window</strong> is described in the User Guide (pages 16 - 18). It has no effect on the reported trend slope or p-value.</p>
<p><strong>qMax</strong> is an argument that allows the user to set the maximum value on the vertical axis. If it is left out, the graphic scales itself. But for a set of similar graphics it may be useful to set qMax.</p>
<p><strong>qUnit</strong> is an argument that allows the user to pick different discharge units. The default is <strong>qUnit = 2</strong> which is cubic meters per second. The other most common unit to use is <strong>qUnit = 1</strong> which is cubic feet per second.</p>
<p><strong>runoff</strong> is a logical argument. The default is <strong>runoff = FALSE</strong>. In some studies it is nice to express discharge in runoff terms (discharge per unit area) amd setting <strong>runoff = TRUE</strong> can cause it to be expressed in terms of runoff.</p>
<p>Here is an example that shows the use of several of these arguments. Say we want to see what would happen if we only looked at annual maximum daily discharge from 1983 - 2010 (trimming off three low years at the start and one high year at the end), and used a shorter smoothing window, and expressed our results as runoff in mm/day</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFlowTrend</span>(eList, <span class="dt">istat =</span> <span class="dv">8</span>, <span class="dt">startDate =</span> <span class="st">"1982-10-01"</span>, <span class="dt">endDate =</span> <span class="st">"2010-09-30"</span>, <span class="dt">window =</span> <span class="dv">15</span>, <span class="dt">runoff =</span> <span class="ot">TRUE</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-9-1.png" alt="Discharge as a function of year runoff plot" width="700"><p class="caption">
Discharge as a function of year runoff plot
</p>
</div>
<p>It is worth noting here that compared to the previous plot of the annual maximum daily discharges, the removal of four particular years brought about a substantial change in the slope and the significance of the trend. This is a common issue in trend analysis with relatively short records.</p>
</div>
<div id="the-quantile-kendall-plot" class="section level1">
<h1 class="hasAnchor">
<a href="#the-quantile-kendall-plot" class="anchor"></a>The Quantile-Kendall Plot</h1>
<p>Now we will look at a new kind of plot called the <em>Quantile-Kendall plot</em>. Each plotted point on the plot is a trend slope (computed in the same manner as in the previous plots) for a given order statistic. The point at the far left edge is the first order statistic, which is the annual minimum daily discharge. This is the result described on the first plot. The next point to its right is the trend slope for the second order statistic (second lowest daily discharge for each year), and it continues to the far right being the trend slope for the 365th order statistic (annual maximum daily discharge). Their placement with respect to the x-axis is based on the z-statistic (standard normal deviate) associated with that order statistic. It is called the daily non-exceedance probability. It is a scale used for convenience. It in no-way assumes that the data follow any particular distribution. It is simply used to provide the greatest resolution near the tails of the daily discharge distribution. The color represents the p value for the Mann-Kendall test for trend as described above. Red indicates a trend that is significant at alpha = 0.05. Black indicates an attained significance between 0.05 and 0.1. The grey dots are trends that are not significant at the alpha level of 0.1.</p>
<p>Here is what it looks like for the Choptank data set. What we see is that generally across the probability distribution the changes are generally not statistically significant except for the highest and second highest days of the year. The trends are slightly negative at the low end of the distribution (the lowest 10%). Near the median they are positive and modestly large (around 1.5% per year). Then near the 90th percentile they drop to near zero slope and only above about the 99th percentile do they seem to be particularly large.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotQuantileKendall</span>(eList)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-10-1.png" alt="The Quantile-Kendall Plot" width="700"><p class="caption">
The Quantile-Kendall Plot
</p>
</div>
<p>There is one special manipulation of the data that is needed to account for leap years (this is a detail about the computation but is not crucial to understanding the plots). The 366 daily values observed in a leap year are reduced by one so that all years have 365 values. The one value eliminated is accomplished by replacing the two middle values in the ranked list of values by a single value which is the average of the two. A similar approach is used when the period of analysis is any set of months that contains the month of February. The number of leap year values are reduced by one and the reduction takes place at the median value for the year.</p>
</div>
<div id="variations-on-the-quantile-kendall" class="section level1">
<h1 class="hasAnchor">
<a href="#variations-on-the-quantile-kendall" class="anchor"></a>Variations on the Quantile Kendall</h1>
<p>We might be interested in particularly looking at trends in a certain season of the year. In the case of the Choptank we know that tropical storm generated floods have been particularly significant in the later part of this record and these have been mostly in August, September and October. Or, if our interest were related to the flows happening in the spring and early summer, which is the period of time during which the delivery to the Chesapeake Bay (into which the Choptank River flows) then we might want to run our analysis on the period March through June. To do that we can use <strong>paStart = 3 and paLong = 4</strong>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotQuantileKendall</span>(eList, <span class="dt">paStart =</span> <span class="dv">3</span>, <span class="dt">paLong =</span> <span class="dv">4</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-11-1.png" alt="The Quantile-Kendall Plot in spring" width="700"><p class="caption">
The Quantile-Kendall Plot in spring
</p>
</div>
<p>What we can see is that for this portion of the year, the discharge trends are rather minimal and certainly not statistically significant, except that the 5 or so highest flow days in the season do show rather large trends and the annual maximum trend is the largest of all (in percent per year) and is the only one that is significcant.</p>
<p>There are a few other arguments for the <strong>plotQuantileKendall</strong> function. As mentioned in the discussion of the <strong>plotFlowTrend</strong> function, it has the <strong>startDate and endDate</strong> arguments. If they aren’t specified then it is assumed that the analysis covers the whole period in the Daily data frame.</p>
<p>There are two arguments that relate to the appearance of the graph.</p>
<p><strong>legendLocation</strong> this argument simply determines where in the graph the legend is placed. It sometimes happens that the legend obscures the data so we may need to move it to another part of the graph. The argument can take on names such as “bottomleft”, “topright” or “bottomright”. The default is “topleft”. If you don’t want a legend (say you are making many Quantile Kendall plots in a single job and can’t go in and adjust each one), then you can specify <strong>legendLocation = NA</strong>.</p>
<p><strong>legendSize</strong> this argument determines the size of the legend. The default is legendSize = 1.0. If you want to decrease the dimensions of the legend you decrease this value. For example a 25% reduction would be achieved by setting <strong>legendSize = 0.75</strong>. Typically one wouldn’t want to go below about 0.4.</p>
<p><strong>yMax and yMin</strong> are two more optional arguments to set up the limits on the y-axis. If you don’t specify them (just leave them out) then the data will dictate the minimum and maximum values on the y-axis (it will extend slightly beyond the highest and lowest values). But, if you are doing many graphs you may want them to have consistent axes, so a quick look at the graph will tell you if the trends are large or small, then you can set these two values. For example, say you want every graph to have a maximum value of 5 and a minimum value of -5, then the arguments would just be: <strong>yMax = 5, yMin = 5</strong>. There is a “fail safe” mechanism in the code if the trends are bigger than the specified values. Let’s say we set <strong>yMax = 5</strong> but in one particular graph there is a trend slope of 7.2 % per year. In this case the y-axis would extend out slightly beyond a value of 7.2. Thus, no value is ever out of range. All of the slopes will be plotted.</p>
<p>Here is an example bringing all of the arguments into play. It is for a case where we want to consider the time period 1982-08-01 through 2010-11-30, for only the months of August through October, and we want the legend to go in the bottom right and be only half the size of what we saw in the first example.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotQuantileKendall</span>(eList, <span class="dt">startDate =</span> <span class="st">"1982-08-01"</span>, <span class="dt">endDate =</span> <span class="st">"2010-11-30"</span>, 
<span class="dt">paStart =</span> <span class="dv">8</span>, <span class="dt">paLong =</span> <span class="dv">3</span>, <span class="dt">legendLocation =</span> <span class="st">"bottomright"</span>, <span class="dt">legendSize =</span> <span class="fl">0.5</span>, <span class="dt">yMax =</span> <span class="dv">4</span>, <span class="dt">yMin =</span> <span class="op">-</span><span class="dv">4</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-12-1.png" alt="The Quantile-Kendall Plot with design modifications" width="700"><p class="caption">
The Quantile-Kendall Plot with design modifications
</p>
</div>
<p>What this graph shows us is that unlike the year as a whole, this late summer to fall period has been one of very substantially increasing discharge. From about the median of the distribution to the top, the trends are greater than 3% per year and many are significant at least at the alpha level of 0.1. There is one feature of this figure that may look odd. That is the fact that at the lower end of the distribution there are many trend slopes that are exactly zero. Using the gray dot at the far left as an example, the trend slope estimation method uses all pairwise comparisons of the lowest discharge of each year. Because of the USGS reporting conventions, many of these discharge values cluster around a few specific values, so that in the comparisons, there are many ties. The slope estimate is the median of all the pairwise slopes and since a significant number of these slopes are zero, the slope estimate is zero.</p>
</div>
<div id="putting-it-all-together-into-a-set-of-five-graphs" class="section level1">
<h1 class="hasAnchor">
<a href="#putting-it-all-together-into-a-set-of-five-graphs" class="anchor"></a>Putting it all together into a set of five graphs</h1>
<p>This post also provides an additional function that produces a total of five graphics from a single command. It does the four trend plots and then the Quantile-Kendall. It is called <strong>plotFiveTrendGraphs.</strong> The arguments are all ones that we have seen before: <strong>eList, startDate, endDate, paStart, paLong, qUnit, window, legendLocation, and legendSize.</strong> In its simplest form it would look like this (output not plotted here).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plotFiveTrendGraphs</span>(eList)</code></pre></div>
</div>
<div id="downloading-the-data-for-your-site-of-interest" class="section level1">
<h1 class="hasAnchor">
<a href="#downloading-the-data-for-your-site-of-interest" class="anchor"></a>Downloading the data for your site of interest</h1>
<p>The steps for downloading data from USGS web services (or obtaining it from user supplied information) and also for creating and saving the eList are described on pages 4-13 of the EGRET user guide. Here is a simple example:</p>
<p>Say we want to look at USGS station number 01646500 (Sugar River near Brodhead, WI) and we want to consider data from Climate Years 1921 through 2016. Note that this much longer period of record causes the computations to take a good deal more time than the previous cases, but it should still take well under a minute to complete the whole job. The following commands would do what is needed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(EGRET)
sta &lt;-<span class="st"> "05436500"</span>
param &lt;-<span class="st"> "00060"</span> <span class="co"># this is the parameter code for daily discharge</span>
startDate &lt;-<span class="st"> "1920-04-01"</span>
endDate &lt;-<span class="st"> "2016-03-31"</span>
INFO &lt;-<span class="st"> </span><span class="kw"><a href="../reference/INFOdataframe.html">readNWISInfo</a></span>(<span class="dt">siteNumber =</span> sta, <span class="dt">parameterCd =</span> param, <span class="dt">interactive =</span> <span class="ot">FALSE</span>)
Daily &lt;-<span class="st"> </span><span class="kw"><a href="../reference/readNWISDaily.html">readNWISDaily</a></span>(<span class="dt">siteNumber =</span> sta, <span class="dt">parameterCd =</span> param, <span class="dt">startDate =</span> startDate, 
<span class="dt">endDate =</span> endDate, <span class="dt">verbose =</span>  <span class="ot">FALSE</span>)
eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/as.egret.html">as.egret</a></span>(INFO, Daily)
<span class="kw">plotFiveTrendGraphs</span>(eList, <span class="dt">legendLocation =</span> <span class="st">"bottomleft"</span>)</code></pre></div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-14-1.png" alt="Quantile-Kendall Plots of the Sugar River near Brodhead, WI" width="700"><p class="caption">
Quantile-Kendall Plots of the Sugar River near Brodhead, WI
</p>
</div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-14-2.png" alt="Quantile-Kendall Plots of the Sugar River near Brodhead, WI" width="700"><p class="caption">
Quantile-Kendall Plots of the Sugar River near Brodhead, WI
</p>
</div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-14-3.png" alt="Quantile-Kendall Plots of the Sugar River near Brodhead, WI" width="700"><p class="caption">
Quantile-Kendall Plots of the Sugar River near Brodhead, WI
</p>
</div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-14-4.png" alt="Quantile-Kendall Plots of the Sugar River near Brodhead, WI" width="700"><p class="caption">
Quantile-Kendall Plots of the Sugar River near Brodhead, WI
</p>
</div>
<div class="figure">
<img src="streamflow_trend_files/figure-html/unnamed-chunk-14-5.png" alt="Quantile-Kendall Plots of the Sugar River near Brodhead, WI" width="700"><p class="caption">
Quantile-Kendall Plots of the Sugar River near Brodhead, WI
</p>
</div>
</div>
<div id="final-thoughts" class="section level1">
<h1 class="hasAnchor">
<a href="#final-thoughts" class="anchor"></a>Final thoughts</h1>
<p>This last set of plots is particularly interesting. What we see is that for the lowest 90 percent of the distribution, discharges have been rising over most of this record, and particularly so since about 1950. But in the highest 1% of the distribution discharges have been falling thoughout the record. As a consequence the overall variablity of streamflow in this agricultural watershed has generally been declining over time. This is generally thought to be related to the increasing use of conservation practices in the watershed.</p>
<p>It is worth noting that we can express the percentage changes per year in other ways than as percent per year, for example percentage change per decade or percentage change over the entire period of record. Take, for example, the estimated trend slope for the median in this last example. It is 0.68% per year. If we were to express that as percentage change per decade it would be 7% per decade (the change can be computed as 1.0068^10, or 1.070, which is a 7% increase). If we expressed it for the entire 96 year record it would be about a 92% increase over that period (computed as 1.0068^96, which is 1.9167 or and increase of about 92%).</p>
<p>These graphical tools are one way of summarizing what we might call a <strong>signature of change</strong> for any given watershed. It shows the changes, or lack of changes, that have taken place through all parts of the probability distribution of streamflow. This has potential as a tool for evaluating hydrologic or linked climate and hydrologic models. Observing the patterns on these graphs for the actual data versus the patterns seen when simulated data are used, can provide insights on the ability of the models used to project hydrologic changes into the future.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#getting-started">Getting Started</a></li>
      <li><a href="#loading-the-necessary-packages-and-other-r-code">Loading the necessary packages and other R code</a></li>
      <li>
<a href="#making-a-graph-of-the-trend-in-a-single-flow-statistic">Making a graph of the trend in a single flow statistic</a><ul class="nav nav-pills nav-stacked">
<li><a href="#explanation-of-the-flowtrend-plot-annual-minimum-day">Explanation of the FlowTrend Plot, annual minimum day</a></li>
      </ul>
</li>
      <li>
<a href="#a-few-more-flowtrend-plots">A few more FlowTrend Plots</a><ul class="nav nav-pills nav-stacked">
<li><a href="#the-annual-median-day">The annual median day</a></li>
      <li><a href="#the-annual-maximum-day">The annual maximum day</a></li>
      </ul>
</li>
      <li><a href="#some-observations-about-these-figures">Some observations about these figures</a></li>
      <li><a href="#variations-on-the-simplest-example">Variations on the simplest example</a></li>
      <li><a href="#the-quantile-kendall-plot">The Quantile-Kendall Plot</a></li>
      <li><a href="#variations-on-the-quantile-kendall">Variations on the Quantile Kendall</a></li>
      <li><a href="#putting-it-all-together-into-a-set-of-five-graphs">Putting it all together into a set of five graphs</a></li>
      <li><a href="#downloading-the-data-for-your-site-of-interest">Downloading the data for your site of interest</a></li>
      <li><a href="#final-thoughts">Final thoughts</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert Hirsch, Laura DeCicco.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
