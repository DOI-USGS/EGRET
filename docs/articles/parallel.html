<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Running WRTDS in parallel • EGRET</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Running WRTDS in parallel">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EGRET</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">3.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Enhancements.html">Guide to EGRET 3.0 enhancements</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running WRTDS in parallel</a>
    </li>
    <li>
      <a href="../articles/rResid.html">Using Random Residuals for Censored Data in EGRET</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/EGRET/wiki">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Running WRTDS in parallel</h1>
                        <h4 class="author">Laura A. De Cicco and Robert M. Hirsch</h4>
            
            <h4 class="date">2017-07-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/EGRET/wiki/blob/master/vignettes/parallel.Rmd"><code>vignettes/parallel.Rmd</code></a></small>
      <div class="hidden name"><code>parallel.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>As of <code>EGRET</code> version 2.6.1, we’ve added the dependency <code>foreach</code>, which can allow the <code>modelEstimation</code> function to be run in parallel. Depending on the available cores, this could significantly speed up the WRTDS calculations. By default, the code is still run serially (ie…not in parallel).</p>
<p>The directions in this vignette show how to take advantage of multiple cores on a single computer. The concept can be extended to cluster computing (for example: HTConder, SLURM (for USGS YETI), Alces Flight,…), but the specific directions for those systems are not covered in this vignette.</p>
<p>The WRTDS routine in the <code>modelEstimation</code> function is the only major process that is improved with parallel processing in the <code>EGRET</code> package. Confidence intervals and trend calculations in the <code>EGRETci</code> package are also updated with parallel capabilities via the <code>foreach</code> package. See the vignette “Running EGRETci in Parallel” in <code>EGRETci</code> for more details.</p>
</div>
<div id="setup" class="section level1">
<h1 class="hasAnchor">
<a href="#setup" class="anchor"></a>Setup</h1>
<p>In order to run WRTDS in parallel and get a computationally efficient advantage, you will first need a computer with multiple cores. Most newer computers are multi-core. To check how many cores your computer has, use the <code>detectCores()</code> function in the <code>parallel</code> packages (which is shipped with the base R installation):</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">detectCores</span>()</a></code></pre></div>
<pre><code>## [1] 8</code></pre>
<p>There is some overhead involved in going from serial to parallel computing, so you should not expect a 1:1 speed-up. If your computer only has 2 cores, you might not see any improvements in efficiency.</p>
<div id="registering-your-cores" class="section level2">
<h2 class="hasAnchor">
<a href="#registering-your-cores" class="anchor"></a>Registering your cores</h2>
<p>Once you’ve checked that your computer has multiple cores, you need to register how many cores you want to use. There are a few ways to do this. It will depend on your operating system and general workflow what exactly is the best way to do this. There are currently 3 main packages that you can use to parallelize the <code>modelEstimation</code> function: <code>doParallel</code>, <code>doSNOW</code>, and <code>doMC</code>.</p>
<p>The <code>doParallel</code> package recommend to most new users because it works best on all three major operating systems (Windows, Mac, Linux). However, <code>doMC</code> can be more efficient on Linux. Therefore, we recommend <code>doParallel</code>, but will show workflows for both of the packages.</p>
<p>It is recommended to use at most <code>detectCores(logical = FALSE) - 1</code> cores for your calculations. This leaves one core available for other computer processes. Most modern CPU’s can handle registering all the cores on your computer without issue. In fact, you could register <em>more</em> cores than are physically on your computer, but could be inefficient. When using the function <code>detectCores</code>, we recommend specifying <code>logical = FALSE</code> because that will find the number of physical cores on your computer. <code>logical=TRUE</code> includes multithreading, which we have found to generally not improve the efficiency in these calculations.</p>
<p>Note: the packages <code>doParallel</code> or <code>doMC</code> are <em>suggested</em> for <code>EGRET</code>. This means they are not automatically installed with the <code>EGRET</code> installation. You will need to install separately the package of your choice.</p>
<p>Important for <em>all</em> workflows, when the processing is completed, you need to stop the cluster registration with the <code>stopCluster</code> function.</p>
<p>We will now show 3 examples using the “Choptank River” example data:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">library</span>(EGRET)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4">eList &lt;-<span class="st"> </span>Choptank_eList</a>
<a class="sourceLine" id="cb3-5" data-line-number="5">nCores &lt;-<span class="st"> </span><span class="kw">detectCores</span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>) <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a></code></pre></div>
<div id="doparellel" class="section level3">
<h3 class="hasAnchor">
<a href="#doparellel" class="anchor"></a>doParellel</h3>
<p>The most generalized workflow uses the <code>doParallel</code> package:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">library</span>(doParallel)</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(nCores)</a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">registerDoParallel</span>(cl)</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/modelEstimation.html">modelEstimation</a></span>(eList, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">run.parallel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="kw">stopCluster</span>(cl)</a></code></pre></div>
</div>
<div id="domc" class="section level3">
<h3 class="hasAnchor">
<a href="#domc" class="anchor"></a>doMC</h3>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">library</span>(doMC)</a>
<a class="sourceLine" id="cb5-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(nCores)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">registerDoMC</span>(cl)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/modelEstimation.html">modelEstimation</a></span>(eList, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">run.parallel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw">stopCluster</span>(cl)</a></code></pre></div>
</div>
</div>
</div>
<div id="simple-benchmarking" class="section level1">
<h1 class="hasAnchor">
<a href="#simple-benchmarking" class="anchor"></a>Simple Benchmarking</h1>
<p>If you plan to use the <code>modelEstimation</code> function frequently, it will be worth trying a simple benchmark test to determine if running the code in parallel makes sense on your system. While significantly more robust benchmark testing is available from several R packages (see <code>microbenchmark</code> for example), a very simple test can be done with the <code>system.time</code> function:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">library</span>(doParallel)</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="kw">library</span>(EGRET)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4"></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">eList &lt;-<span class="st"> </span>Choptank_eList</a>
<a class="sourceLine" id="cb6-6" data-line-number="6"></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">nCores &lt;-<span class="st"> </span><span class="kw">detectCores</span>(<span class="dt">logical =</span> <span class="ot">FALSE</span>) <span class="op">-</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="kw">system.time</span>({</a>
<a class="sourceLine" id="cb6-10" data-line-number="10">  cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(nCores)</a>
<a class="sourceLine" id="cb6-11" data-line-number="11">  <span class="kw">registerDoParallel</span>(cl)</a>
<a class="sourceLine" id="cb6-12" data-line-number="12">  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/modelEstimation.html">modelEstimation</a></span>(eList, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">run.parallel =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb6-13" data-line-number="13">  <span class="kw">stopCluster</span>(cl)</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">})</a></code></pre></div>
<pre><code>user  system elapsed 
   9.11    0.95   33.34</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">system.time</span>({</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  eList &lt;-<span class="st"> </span><span class="kw"><a href="../reference/modelEstimation.html">modelEstimation</a></span>(eList, <span class="dt">verbose =</span> <span class="ot">FALSE</span>, <span class="dt">run.parallel =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">})</a></code></pre></div>
<pre><code>   user  system elapsed 
  60.05    0.05   60.51 </code></pre>
<p>If the timing of the parallel code is not significantly faster (or even slower!) than the regular non-parallel code, it is not worth running in parallel on your current computer.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li>
<a href="#setup">Setup</a><ul class="nav nav-pills nav-stacked">
<li><a href="#registering-your-cores">Registering your cores</a></li>
      </ul>
</li>
      <li><a href="#simple-benchmarking">Simple Benchmarking</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Robert Hirsch, Laura DeCicco.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
