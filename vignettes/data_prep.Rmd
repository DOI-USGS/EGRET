---
title: "Data Input"
author: "Laura DeCicco"
date: "2019-03-26"
subtitle: "Entering data into EGRET and running an analysis"
output:
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Data Input}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

# Introduction

```{r include=TRUE ,echo=FALSE,eval=TRUE, message=FALSE, warning=FALSE}

#Note: for slides, try ioslides_presentation as output above

# output:
#   rmarkdown::html_vignette:
#     toc: true
# 
# vignette: >
#   %\VignetteEngine{knitr::rmarkdown}
#   %\VignetteIndexEntry{Data Input}
#   \usepackage[utf8]{inputenc}
# 
# Or slides:
# output:
#   ioslides_presentation:
#     css: css/stylesSlides.css
#     logo: img/simple-shadow.png
#     widescreen: yes


library(EGRET)
library(knitr)

knitr::opts_chunk$set(echo = TRUE, 
                      warning = FALSE, 
                      message = FALSE,
                      fig.height=7,
                      fig.width=7)

```

Exploration and Graphics for RivEr Trends (`EGRET`): 
An R-package for the analysis of long-term changes in water quality and streamflow.

Here we discuss how to get your data into `EGRET`, and how to run a basic analysis.

# Data Requirements

There are 2 required data sets to create an `EGRET` object: "Daily" and "INFO". There's an additional third required data set to run a WRTDS model or analyze water quality data: "Sample".

## Daily

The "Daily" data frame is the full record of discharge. The minimum information you need is a column of dates, and a column of discharge values in *cubic meters pre second* (cms). There are helpful tools included to help this process. There are 2 ways to create the "Daily" data frame.

### NWIS Data

One is by web services. `EGRET` has a function `readNWISDaily` that taps into the NWIS (USGS) web services. The minimum information to use this function is to know the USGS site ID. Optionally, you can set a start and end date.

```{r nwisDaily, cache=TRUE}
siteNumber <- "01491000"
Daily <- readNWISDaily(siteNumber)
names(Daily)

```

We see here there are more columns than minimum required. Each additional column is derived from the 2 required raw data columns, and are used throughout the `EGRET` analysis.

### User Data

There is a function `readUserDaily`, that will import a text file. For example, there is a sample text file that is tab-delimited that looks like this:

```
date  Qdaily
10/1/1999  107
10/2/1999  85
10/3/1999  76
10/4/1999  76
10/5/1999   113
10/6/1999   98
...

```

That file can be converted to a "Daily" data frame using the following commands:

```{r userDaily, eval=FALSE}
filePath <- system.file("extdata", package="EGRET")
fileName <- "ChoptankRiverFlow.txt"
Daily <- readUserDaily(filePath,fileName,separator="\t")

```

It is also possible to import data into R in many other ways. For example, you may wish to pull your data directly from an Excel file, wrangle and clean it in R, and then convert it to a "Daily" data frame. You can mimic the innereds of the `readUserDaily` function like this:

```{r otherUserDaily, eval=FALSE}
library(readxl)
userData <- read_excel("discharge.xlxs", 
                       sheet = "Example", 
                       skip = 3)
# do some filter/cleaning/etc
names(userData) <- c("dateTime", "value")
# qConvert is the conversion TO cms
Daily <- populateDaily(userData,qConvert = 35.314667)
```

## Sample

There are several functions in `EGRET` that are only designed for streamflow analysis. However, if you are using `EGRET` for water quality analysis, you will need the water quality measurements in a "Sample" data frame. In this section, we need to introduce the concept of censored data, then we'll look at the ways to import your data.

### Censored Data Explanation

Censored data is when the measurement is either:

```{r cenTable, echo=FALSE}

x <- data.frame(Name = c("Uncensored","Less than", "Greater than", "Interval"),
                Code = c("","<",">","I"),
                Example = c("Known value",
                            "Mimimum detection of a method",
                            "Maximum detection level, such as counts on a petri dish",
                            "Coumpound analytes"),
                ConcLow = c("Known Value","NA","Maximum Detection","ConcLow"),
                ConcHigh = c("Known Value","Minimum Detection","NA","ConcHigh"),
  stringsAsFactors = FALSE
)
kable(x)

```

The math is handled using "survival analysis", also known as "tobit regression".Censored values are represented by bars in `EGRET` plots.

```{r exampleCensors, echo=FALSE, fig.height=4}
x <- c(1,2,3,4,5,6)
y <- c(1,3,4,3.3,4.4,7)
xlim <- c(min(x)*.75,max(x)*1.25)
ylim <- c(0,1.25*max(y))
xTicks <- pretty(xlim)
yTicks <- pretty(ylim)
genericEGRETDotPlot(x=x, y=y,
                     xlim=xlim, ylim=ylim,
                     xTicks=xTicks, yTicks=yTicks
 )
 yBottom <- 0
 yLow <- c(NA,3,4,3.3,4,7)
 yHigh <- c(1,3,4,3.3,5,NA)
 Uncen <- c(0,1,1,1,0,0)
 censoredSegments(yBottom=yBottom,yLow=yLow,yHigh=yHigh,x=x,Uncen=Uncen)

```

### Compound Example

An example of compound analytes is when the analyte of interest is the sum of two or more measured analytes. A real life example is total nitrogen, which is computed as Ammonia plus organic N, unfiltered plus Nitrate plus nitrite, filtered.

Here is some completely fake data to illustrate the concept:

```{r compound, echo=FALSE}
dateTime <- c('1985-01-01', '1985-01-02', '1985-01-03')
comment1 <- c("","","")
value1 <- c(1,2,3)
comment2 <- c("","<","")
value2 <- c(2,3,4)
comment3 <- c("","","<")
value3 <- c(3,4,5)
dataInput <- data.frame(dateTime, comment1, value1, 
      comment2, value2, 
      comment3, value3, stringsAsFactors=FALSE)


kable(dataInput)
kable(compressData(dataInput))

```

### NWIS 

Using web services, `EGRET` uses remark codes to populate the concention values (low, high). In addition to the USGS site ID, this function requires a 5-digit parameter code to get the data. 

```{r sampleNWIS, cache=TRUE}
parameter_cd <- "00631" #Inorganic Nitrogen
Sample <- readNWISSample(siteNumber,parameter_cd)
names(Sample)

```

### Water Quality Portal

```{r WQPSample, cache=TRUE}
site <- 'WIDNR_WQX-10032762'
characteristicName <- 'Specific conductance'
Sample <- readWQPSample(site,
                        characteristicName, "", "")
names(Sample)

```


### User Data

There is a function `readUserSample` that will read in simple text files and convert them to "Sample" data frames. The data must have 3 columns, the first a date, the second a remark code (including "","<",or ">"), and the third the measured value.

For example, there is a sample text file that is semicolon-delimited that looks like this:

```
cdate;remarkCode;Nitrate;remarkCode2;Nitrate2
1999-10-07;;1.4;;1.2
1999-11-04;<;0.99;<;0.25
1999-12-30;;1.42;;1.4
2000-01-04;;1.59;;2.1
2000-02-03;;1.54;;1.0
2000-02-15;;1.37;<;.50
2000-02-19;<;1.24;;1.4
...
```

This file can be converted to a "Sample" data frame with the following commands:

```{r userSample}
fileName <- "ChoptankRiverNitrate.csv"
filePath <-  system.file("extdata", package = "EGRET")
Sample <- readUserSample(filePath,fileName,
                                separator=";")

```

## Info

Finally, the "INFO" data frame includes all the metadata for the site and analyte that is required for `EGRET` analysis. There are functions to obtain this information from either NWIS or WQP. There's a function to interactively type in the data. The data frame can also be created in R. The minimum required columns are:

```{r minInfo}
INFO <- data.frame(
    shortName = "Choptank",
    staAbbrev	= "Chop",
    paramShortName	= "Inorganic Nitrogen",
    constitAbbrev = "N",
    drainSqKm = 100, #Drainage area in km^2,
    paStart = 10,
    paLong = 12,
    stringsAsFactors = FALSE
)
```

### NWIS

```{r infoNWIS, cache=TRUE}
INFO <- readNWISInfo(siteNumber, 
                     parameter_cd, 
                     interactive = FALSE)
INFO$shortName <- "Choptank River at Greensboro, MD"

```

### WQP

```{r wqpINFO, cache=TRUE}
INFO_WQP <- readWQPInfo("USGS-01491000",parameter_cd,
                        interactive = FALSE)
INFO_WQP$shortName <- "Choptank River at Greensboro, MD"

```


