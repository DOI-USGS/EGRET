---
title: "Trends by month"
author: "Robert M. Hirsch"
output: 
  rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Trends by month}
  \usepackage[utf8]{inputenc}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Introduction

This vignette is about producing a single type of figure.  It is designed to examine the trends between a pair of years (using **runPairs** in EGRET terminology) to see what the size of the trend is for each of the twelve months of the year.  It was used to make Figure 8 in Choquette et al., 2019.  It is very helpful in trying to see if the trend is very specific to a certain part of the year (or even opposite in different parts of the year) versus being fairly similar across all the months.

As of `EGRET` version 3.0.7.2 (or CRAN version 3.0.8), the output of `runPairs` includes information about the trends per individual month. This output is attached via an attribute called "byMonth".

## How to do it

You need one custom plotting function functions, **plotOne.R**.  You should set up a working directory and then you can copy the function into your working directory.  You'll need an EGRET eList in the directory as well.  It should be an eList for which `modelEstimation` has already been run.

Here is the code

```{r include=TRUE, eval = TRUE}

# the arguments yMax, arrowFactor, and name can all be
# adjusted to make some changes in the figure
plotOne <- function(pairResults, yMax = NA,
                    arrowFactor = 0.4, flux = TRUE, 
                    name = "Change in yield, by month"){
  
  z <- attr(pairResults, "byMonth")

  monthAbb <- c("J","F","M","A","M","J","J","A","S","O","N","D")
  if(flux){
    z1 <- as.numeric(z[which(z$Type == "Flux" & z$Year == min(z$Year)),3:14])
    z2 <- as.numeric(z[which(z$Type == "Flux" & z$Year == max(z$Year)),3:14])
  } else {
    z1 <- as.numeric(z[which(z$Type == "Conc" & z$Year == min(z$Year)),3:14])
    z2 <- as.numeric(z[which(z$Type == "Conc" & z$Year == max(z$Year)),3:14])
  }
  
  zMax <- max(c(z1, z2))
  yMax <- if(is.na(yMax)) zMax * 1.05 else yMax
  
  ylab <- ifelse(flux, "Change in yield, kg / month / km^2",
                 "Change in concentration, mg / L / month")
  par(las = 1, tck = 0.02, xaxs = "i", yaxs = "i")
  plot(seq(1,12),z1,xlim = c(0.5,12.5), ylim = c(0, yMax),
        xlab = "", ylab = ylab,
       main = name, col = "black", axes = FALSE, cex.lab = 0.95)
  axis(1, at = seq(1, 12), labels = monthAbb, tick = TRUE)
  axis(2, at = NULL, labels = TRUE, tick = TRUE)
  axis(3, at = seq(1, 12), labels = FALSE, tick = TRUE)
  axis(4, at = NULL, labels = FALSE, tick = TRUE)
  box()
  par(new = TRUE)
  plot(seq(1,12),z2, xlim = c(0.5,12.5), ylim = c(0, yMax),
       xlab = "", ylab = "",
       main = "", col = "red", axes = FALSE)

  for(m in 1: 12){
    x0 <- m
    x1 <- m

    y0 <- z1[m]
    y1 <- z2[m]

    col <- if(y1 > y0) "red" else "black"
    length <- arrowFactor * abs(y1 - y0) 
    angle <- 30
    lwd <- 2
    arrows(x0, y0, x1, y1, length = length, angle = angle, col = col, lwd = lwd)
  }
}
```

Now let's run it

```{r eval = TRUE, echo = TRUE}

library(EGRET)
load("Conowingo.PO4.RData")
# source("runPairsMonths.R")
# source("plotOne.R")
pairResults <- runPairs(eList, windowSide = 0,
                        year1 = 2006, year2 = 2017, 
                        includeMonth = TRUE)


plotOne(pairResults)
```


We might want to make a few changes in the look of the figure, for example:

```{r eval = TRUE, echo = TRUE}
plotOne(pairResults, yMax = 1.2, 
        arrowFactor = 0.6, 
        name = "Change in yield between 2006 and 2017\nPO4 at Conowingo")
```

We could also look at concentration:

```{r eval = TRUE, echo = TRUE}
plotOne(pairResults, arrowFactor = 100000,
        flux = FALSE,
        name = "Change in concentration between 2006 and 2017\nPO4 at Conowingo")
```

# Reference cited

Choquette, A.F., Hirsch, R.M., Murphy, J.C., Johnson, L.T. and Confesor Jr, R.B., 2019. Tracking changes in nutrient delivery to western Lake Erie: Approaches to compensate for variability and trends in streamflow. Journal of Great Lakes Research, 45(1), pp.21-39.

