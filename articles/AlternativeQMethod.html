<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using a WRTDS model where the discharge variable is not daily discharge • EGRET</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using a WRTDS model where the discharge variable is not daily discharge">
<meta property="og:description" content="EGRET">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EGRET</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.4.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/EGRET.html">Introduction</a>
</li>
<li>
  <a href="../reference/index.html">Function Help Pages</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Enhancements.html">Enhancements</a>
    </li>
    <li>
      <a href="../articles/WRTDSK.html">WRTDS Kalman</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running in Parallel</a>
    </li>
    <li>
      <a href="../articles/rResid.html">Random Residuals</a>
    </li>
    <li>
      <a href="../articles/SeasonalFraction.html">Seasonal Analysis</a>
    </li>
    <li>
      <a href="../articles/streamflow_trend.html">Daily Streamflow Trends</a>
    </li>
    <li>
      <a href="../articles/TrendsByMonth.html">Trends by month</a>
    </li>
    <li>
      <a href="../articles/AlternativeQMethod.html">Alternative Q Method</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/References_WRTDS.html">Bibliograpy</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/EGRET">
    <span class="fas fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="AlternativeQMethod_files/header-attrs-2.7/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using a WRTDS model where the discharge variable is not daily discharge</h1>
                        <h4 class="author">Robert M. Hirsch</h4>
            
            <h4 class="date">2021-03-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/EGRET/blob/master/vignettes/AlternativeQMethod.Rmd"><code>vignettes/AlternativeQMethod.Rmd</code></a></small>
      <div class="hidden name"><code>AlternativeQMethod.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Sometimes the usual formulation of WRTDS is not ideal, because we believe that the daily discharge on the sampling day is not a very good explanatory variable, and we have an idea of a better variable we might use. Dams and reservoirs create situations where this may be an issue. A common example of this might be where the discharge at the sampling location is really just determined by the decision of a dam operator and not a real measure of the hydrologic conditions in the watershed and reservoir.</p>
<p>We will work with an example data set here for the Green River near Greendale, UT, and the variable of interest is total dissolved solids. This streamgage is immediately downstream of Flaming Gorge Reservoir. The period of water quality record we will work with covers water years 1966 through 2000. The daily discharge record at this site is very strongly controlled by release decisions made at the dam (for delivery to downstream water users and for hydropower) and is not closely related to hydrologic conditions in the watershed (which covers 19,400 square miles) and includes high mountain areas such as the Wind River Range as well as a lot of high desert in southwestern Wyoming. We will attempt to use the streamgage that is located just upstream of the reservoir, Green River near Green River Wyoming (the location that John Wesley Powell started his famous journey down through the Grand Canyon). This streamgage has a drainage area of 14,000 square miles, but much of the intervening drainage area between the two streamgages is quite arid, so the flows at the upper gage make up a large fraction of the water that comes out at the downstream end of the full watershed.</p>
<p>Our thinking is that the TDS values below the dam might be much better explained by a running mean of discharges at the upstream site, which would be more indicative of basin-wide hydrologic conditions. Because the reservoir stores so much water, we would expect that concentrations at the outflow would change very gradually given the very large mixing volume of the reservoir. In fact, the full-pool capacity of the reservoir is equal to about 2.5 years of streamflow.</p>
<p>So we will start by pulling in the data sets for the Greendale streamgage and running a standard WRTDS model for TDS, and also pull in the discharge data from the Green River streamgage that we will use later. In setting up the example we will also input two functions that are not in EGRET at this point. They are called “errorStats.R” and “estDailyFromSurfacesNEW.R”.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pubs.usgs.gov/tm/04/a10/">EGRET</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://zoo.R-Forge.R-project.org/">zoo</a></span><span class="op">)</span> <span class="co"># zoo is a time series package, needed for rolling means</span>

<span class="co">##################</span>
<span class="va">sta</span> <span class="op">&lt;-</span> <span class="st">"09234500"</span>
<span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"70301"</span>
<span class="va">startDate</span> <span class="op">&lt;-</span> <span class="st">"1966-10-01"</span>
<span class="va">endDate</span> <span class="op">&lt;-</span> <span class="st">"2000-09-30"</span>
<span class="va">INFO</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/INFOdataframe.html">readNWISInfo</a></span><span class="op">(</span><span class="va">sta</span>, <span class="va">param</span>, interactive <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">Daily</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNWISDaily.html">readNWISDaily</a></span><span class="op">(</span><span class="va">sta</span>, <span class="st">"00060"</span>, <span class="va">startDate</span>, <span class="va">endDate</span><span class="op">)</span></code></pre></div>
<pre><code>## There are 12419 data points, and 12419 days.</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNWISSample.html">readNWISSample</a></span><span class="op">(</span><span class="va">sta</span>, <span class="va">param</span>, <span class="va">startDate</span>, <span class="va">endDate</span><span class="op">)</span>
<span class="va">eList</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeReport.html">mergeReport</a></span><span class="op">(</span><span class="va">INFO</span>, <span class="va">Daily</span>, <span class="va">Sample</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Discharge Record is 12419 days long, which is 34 years
##  First day of the discharge record is 1966-10-01 and last day is 2000-09-30
##  The water quality record has 324 samples
##  The first sample is from 1966-10-04 and the last sample is from 2000-08-30
##  Discharge: Minimum, mean and maximum 11.9 62.6 348
##  Concentration: Minimum, mean and maximum 320 470 630
##  Percentage of the sample values that are censored is 0 %</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">INFO</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">INFO</span>  <span class="co"># we will need this later</span>
<span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span>  <span class="co"># we will need this later</span>
<span class="fu"><a href="../reference/multiPlotDataOverview.html">multiPlotDataOverview</a></span><span class="op">(</span><span class="va">eList</span>, logScaleConc <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-1-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's also see what a little slice of the discharge record looks like</span>
<span class="fu"><a href="../reference/plotQTimeDaily.html">plotQTimeDaily</a></span><span class="op">(</span><span class="va">eList</span>, yearStart <span class="op">=</span> <span class="fl">1975</span>, yearEnd <span class="op">=</span> <span class="fl">1979</span>, qLower <span class="op">=</span> <span class="fl">0</span>, qUnit <span class="op">=</span> <span class="fl">2</span>, lwd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-1-2.png" width="700"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eListRegular</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modelEstimation.html">modelEstimation</a></span><span class="op">(</span><span class="va">eList</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  first step running estCrossVal may take about 1 minute
##  estCrossVal % complete:
## 0    1   2   3   4   5   6   7   8   9   10  
## 11   12  13  14  15  16  17  18  19  20  
## 21   22  23  24  25  26  27  28  29  30  
## 31   32  33  34  35  36  37  38  39  40  
## 41   42  43  44  45  46  47  48  49  50  
## 51   52  53  54  55  56  57  58  59  60  
## 61   62  63  64  65  66  67  68  69  70  
## 71   72  73  74  75  76  77  78  79  80  
## 81   82  83  84  85  86  87  88  89  90  
## 91   92  93  94  95  96  97  98  99  
## Next step running  estSurfaces with survival regression:
## Survival regression (% complete):
## 0    1   2   3   4   5   6   7   8   9   10  
## 11   12  13  14  15  16  17  18  19  20  
## 21   22  23  24  25  26  27  28  29  30  
## 31   32  33  34  35  36  37  38  39  40  
## 41   42  43  44  45  46  47  48  49  50  
## 51   52  53  54  55  56  57  58  59  60  
## 61   62  63  64  65  66  67  68  69  70  
## 71   72  73  74  75  76  77  78  79  80  
## 81   82  83  84  85  86  87  88  89  90  
## 91   92  93  94  95  96  97  98  99  
## Survival regression: Done</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/fluxBiasMulti.html">fluxBiasMulti</a></span><span class="op">(</span><span class="va">eListRegular</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-1-3.png" width="700"></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># let's see how the model worked out going into and coming out of a severe drought year</span>
<span class="fu"><a href="../reference/plotConcTimeDaily.html">plotConcTimeDaily</a></span><span class="op">(</span><span class="va">eListRegular</span>, yearStart <span class="op">=</span> <span class="fl">1977.0</span>, yearEnd <span class="op">=</span> <span class="fl">1979.0</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-1-4.png" width="700"></p>
<p>What I think we are seeing in this final plot is that after the end of the 1977 drought, the WRTDS model expects concentrations to come back more to the normal range, but they actually end up being higher because during the drought the usual low-TDS inflow of the Spring and Summer of 1977 never really came and thus the contents of the reservoir went to a much higher concentration than one would expect for the time of year.</p>
<p>We can evaluate the accuracy of this WRTDS model for the whole period modeled here by computing an R-square value. This is computed as (Var(log(C)) - Var(errors of log(C))) / Var(log(C). We use the code “computeRsq.R” to do that.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/errorStats.html">errorStats</a></span><span class="op">(</span><span class="va">eListRegular</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Root Mean Squared Error in natural log units =  0.0738
##  Rsquared for natural log of concentration    =  0.583
##  Rsquared for natural log of flux             =  0.979
##  Standard error of estimate = 7.39 %</code></pre>
<pre><code>##   RsqLogC RsqLogF   rmse sepPercent
## 1   0.583   0.979 0.0738       7.39</code></pre>
<p>Notice that the Rsquared on log(Flux) is very high, nearly 98%. But, this is really a “dishonest” measure of the quality of the model, because so much of flux is determined by discharge. The really honest measure of the quality of the model is the Rsquared on log(Concentration) which is about 58%.</p>
</div>
<div id="bringing-in-the-upstream-discharge-data-and-computing-the-rolling-mean" class="section level1">
<h1 class="hasAnchor">
<a href="#bringing-in-the-upstream-discharge-data-and-computing-the-rolling-mean" class="anchor"></a>Bringing in the upstream discharge data and computing the rolling mean</h1>
<p>Now, let’s bring in the data for the upstream site. We are only bringing in the discharge data, but we will start this record 5 years prior to the start of the Daily record we are using at the Greendale site. We do this because we want to do running averages and we might want to consider averages that run back a few years (since the reservoir stores multiple years worth of water).</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">staUp</span> <span class="op">&lt;-</span> <span class="st">"09217000"</span>
<span class="va">startUp</span> <span class="op">&lt;-</span> <span class="st">"1961-10-01"</span>
<span class="va">DailyUp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNWISDaily.html">readNWISDaily</a></span><span class="op">(</span><span class="va">staUp</span>, <span class="st">"00060"</span>, <span class="va">startUp</span>, <span class="va">endDate</span><span class="op">)</span> </code></pre></div>
<pre><code>## There are 14245 data points, and 14245 days.</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># we can take a look at the record here</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">DailyUp</span><span class="op">$</span><span class="va">Date</span>, <span class="va">DailyUp</span><span class="op">$</span><span class="va">Q</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>Now, what we want to do is try using a rolling mean of the inflows at the upstream site as an explanatory variable in place of the discharge at Greendale. But we need to explore a couple of things. One is how far back in time we want this rolling mean to start. Given that this is a very large reservoir for the size of the average flow I’d like to consider rolling means that go back a few years. We will start with the 1-year rolling mean, and then step through some longer and shorter ones later.</p>
<p>What we are going to do is this. We will take the Daily data frame from the Greendale (downstream) site and create a new column called Qa (meaning Q actual) which we will use later in the process to actually compute the fluxes. Then we will do the 1-year rolling mean for the upstream site (GreenRiver) and put that into the Daily data frame and call that Q, and then compute the natural log of Q and put that in the LogQ column. One other thing we need to think about is that we need to have the Green River data go back prior to the period we are estimating at Greendale, so we can do the rolling means, but then we have to clip it off so the dates in the Daily record at Green River exactly match the dates in the Daily record at Greendale. Here’s the code for all that.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span> <span class="op">&lt;-</span> <span class="va">eListRegular</span><span class="op">$</span><span class="va">Daily</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">Qa</span> <span class="op">&lt;-</span> <span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="va">DailyUp</span>
<span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span><span class="op">(</span><span class="va">DailyUp</span><span class="op">$</span><span class="va">Q</span>,<span class="fl">365</span>, fill <span class="op">=</span> <span class="cn">NA</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
<span class="co"># note that fill = NA means that if we are trying to compute the rolling mean and there</span>
<span class="co"># aren't enough prior values to do it we just put in an NA</span>
<span class="co"># align = "right" means that we associate the rolling mean with the "right most" (final) date</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">DailyUpTemp</span>, <span class="va">Date</span> <span class="op">&gt;=</span> <span class="va">startDate</span><span class="op">)</span>
<span class="co"># let's check that DailyUpTemp is exactaly as long as Daily</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span>
<span class="co"># now we create a new eList that uses this rolling mean discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeReport.html">mergeReport</a></span><span class="op">(</span><span class="va">INFO</span>, <span class="va">Daily</span>, <span class="va">Sample</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Discharge Record is 12419 days long, which is 34 years
##  First day of the discharge record is 1966-10-01 and last day is 2000-09-30
##  The water quality record has 324 samples
##  The first sample is from 1966-10-04 and the last sample is from 2000-08-30
##  Discharge: Minimum, mean and maximum 14.7 49.4 89.3
##  Concentration: Minimum, mean and maximum 320 470 630
##  Percentage of the sample values that are censored is 0 %</code></pre>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># here is the time series of the 1-year rolling mean, plotted on the same scale as before</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Date</span>, <span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>So, we see that we have a new discharge time series that is much less variable than the original. This raises an interesting point. We are about to estimate a WRTDS model with this new Q variable, but it doesn’t make sense to use the standard assumption about a good value for the windowQ variable. Normally, we find that windowQ = 2 works well for regular discharge data sets? But, is it reasonable to expect that this may be too large a value, because LogQ is so much less variable than the original Q variable. So, for a first crack at this problem I’m going to set windowQ equal to half the interquartile range of LogQ for this rolling mean discharge. (I did a little extra stuff to see if that assumption of using half the interquartile range is a good choice. My experience tells me that this is pretty good and the results are pretty insensitive to the choice.) So let’s do that and estimate the model and then evaluate the model using our computeRsq function.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iqr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span><span class="op">)</span>
<span class="va">iqr</span></code></pre></div>
<pre><code>## [1] 0.5009981</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># for comparison let's look at the IQR for the original model we estimated</span>
<span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 0.8206605</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now let's estimate the new model using the rolling mean in place of the daily discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modelEstimation.html">modelEstimation</a></span><span class="op">(</span><span class="va">eListRoll</span>, windowQ <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">iqr</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># let's see how this new model does at estimating the concentration for that 1977-1978 period</span>
<span class="co"># that we looked at before</span>
<span class="fu"><a href="../reference/plotConcTimeDaily.html">plotConcTimeDaily</a></span><span class="op">(</span><span class="va">eListRoll</span>, yearStart <span class="op">=</span> <span class="fl">1977.0</span>, yearEnd <span class="op">=</span> <span class="fl">1979.0</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># recall that with the original model the Rsq value was 0.583</span>
<span class="fu"><a href="../reference/errorStats.html">errorStats</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Root Mean Squared Error in natural log units =  0.0679
##  Rsquared for natural log of concentration    =  0.647
##  Rsquared for natural log of flux             =  0.961
##  Standard error of estimate = 6.79 %</code></pre>
<pre><code>##   RsqLogC RsqLogF   rmse sepPercent
## 1   0.647   0.961 0.0679       6.79</code></pre>
<p>We can see that we have boosted the Rsquared value from the original value of 0.583 up to a new value of 0.647. So we are getting somewhat better, but our selection of the 1-year rolling mean window was just a guess. Let’s try some other values. Let’s do one with half the width (half a year), and then one with twice the width (2 year) and see if either is better than the 1-year.</p>
<p>Here it is with half a year rolling mean</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">Daily</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">Qa</span> <span class="op">&lt;-</span> <span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="va">DailyUp</span>
<span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span><span class="op">(</span><span class="va">DailyUp</span><span class="op">$</span><span class="va">Q</span>, <span class="fl">182</span>, fill <span class="op">=</span> <span class="cn">NA</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">DailyUpTemp</span>, <span class="va">Date</span> <span class="op">&gt;=</span> <span class="va">startDate</span><span class="op">)</span>
<span class="co"># let's check that DailyUpTemp is exactaly as long as Daily</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span>
<span class="co"># now we create a new eList that uses this rolling mean discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeReport.html">mergeReport</a></span><span class="op">(</span><span class="va">INFO</span>, <span class="va">Daily</span>, <span class="va">Sample</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Discharge Record is 12419 days long, which is 34 years
##  First day of the discharge record is 1966-10-01 and last day is 2000-09-30
##  The water quality record has 324 samples
##  The first sample is from 1966-10-04 and the last sample is from 2000-08-30
##  Discharge: Minimum, mean and maximum 7.59 49.4 154
##  Concentration: Minimum, mean and maximum 320 470 630
##  Percentage of the sample values that are censored is 0 %</code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># here is the time series of the half-year rolling mean, plotted on the same scale as before</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Date</span>, <span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iqr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span><span class="op">)</span>
<span class="va">iqr</span></code></pre></div>
<pre><code>## [1] 0.8526911</code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now let's estimate the new model using the rolling mean in place of the daily discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modelEstimation.html">modelEstimation</a></span><span class="op">(</span><span class="va">eListRoll</span>, windowQ <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">iqr</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># let's see how this new model does at estimating the concentration for that 1977-1978 period</span>
<span class="co"># that we looked at before</span>
<span class="fu"><a href="../reference/plotConcTimeDaily.html">plotConcTimeDaily</a></span><span class="op">(</span><span class="va">eListRoll</span>, yearStart <span class="op">=</span> <span class="fl">1977.0</span>, yearEnd <span class="op">=</span> <span class="fl">1979.0</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># recall that with the original model the Rsq value was 0.583</span>
<span class="fu"><a href="../reference/errorStats.html">errorStats</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Root Mean Squared Error in natural log units =  0.0758
##  Rsquared for natural log of concentration    =  0.56
##  Rsquared for natural log of flux             =  0.981
##  Standard error of estimate = 7.59 %</code></pre>
<pre><code>##   RsqLogC RsqLogF   rmse sepPercent
## 1    0.56   0.981 0.0758       7.59</code></pre>
<p>And now with a 2 year rolling mean</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">Daily</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">Qa</span> <span class="op">&lt;-</span> <span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="va">DailyUp</span>
<span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/zoo/man/rollmean.html">rollmean</a></span><span class="op">(</span><span class="va">DailyUp</span><span class="op">$</span><span class="va">Q</span>, <span class="fl">730</span>, fill <span class="op">=</span> <span class="cn">NA</span>, align <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span>
<span class="va">DailyUpTemp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">DailyUpTemp</span>, <span class="va">Date</span> <span class="op">&gt;=</span> <span class="va">startDate</span><span class="op">)</span>
<span class="co"># let's check that DailyUpTemp is exactaly as long as Daily</span>
<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 12419</code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span> <span class="op">&lt;-</span> <span class="va">DailyUpTemp</span><span class="op">$</span><span class="va">Q</span>
<span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span>
<span class="co"># now we create a new eList that uses this rolling mean discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mergeReport.html">mergeReport</a></span><span class="op">(</span><span class="va">INFO</span>, <span class="va">Daily</span>, <span class="va">Sample</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Discharge Record is 12419 days long, which is 34 years
##  First day of the discharge record is 1966-10-01 and last day is 2000-09-30
##  The water quality record has 324 samples
##  The first sample is from 1966-10-04 and the last sample is from 2000-08-30
##  Discharge: Minimum, mean and maximum 21.1 49.7 82
##  Concentration: Minimum, mean and maximum 320 470 630
##  Percentage of the sample values that are censored is 0 %</code></pre>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># here is the time series of the 2-year rolling mean, plotted on the same scale as before</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Date</span>, <span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span>, type <span class="op">=</span> <span class="st">"l"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">500</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, tck <span class="op">=</span> <span class="fl">0.02</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iqr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/IQR.html">IQR</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">LogQ</span><span class="op">)</span>
<span class="va">iqr</span></code></pre></div>
<pre><code>## [1] 0.4638389</code></pre>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># now let's estimate the new model using the rolling mean in place of the daily discharge</span>
<span class="va">eListRoll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/modelEstimation.html">modelEstimation</a></span><span class="op">(</span><span class="va">eListRoll</span>, windowQ <span class="op">=</span> <span class="fl">0.5</span> <span class="op">*</span> <span class="va">iqr</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># let's see how this new model does at estimating the concentration for that 1977-1978 period</span>
<span class="co"># that we looked at before</span>
<span class="fu"><a href="../reference/plotConcTimeDaily.html">plotConcTimeDaily</a></span><span class="op">(</span><span class="va">eListRoll</span>, yearStart <span class="op">=</span> <span class="fl">1977.0</span>, yearEnd <span class="op">=</span> <span class="fl">1979.0</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># recall that with the original model the Rsq value was 0.583</span>
<span class="fu"><a href="../reference/errorStats.html">errorStats</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##  Root Mean Squared Error in natural log units =  0.0602
##  Rsquared for natural log of concentration    =  0.723
##  Rsquared for natural log of flux             =  0.939
##  Standard error of estimate = 6.02 %</code></pre>
<pre><code>##   RsqLogC RsqLogF   rmse sepPercent
## 1   0.723   0.939 0.0602       6.02</code></pre>
<p>So, we see that a half-year rolling mean didn’t do us any good. The model got worse. But the 2 year was an improvement. The Rsquared went up to 0.72. So, the question is now, what about a 3 year window. Might that work better? I’m not going to show the results here, but when I did it, the Rsquared went down slightly from the 2 year window (Rsquared 0.70). I’m going to declare that the best option is to use the 2-year rolling mean. (I don’t like the idea of using non-integers for the number of years in the rolling mean because then there will be seasonality to the discharge variable. It could work but it is not as simple to think about).</p>
</div>
<div id="how-do-we-use-the-selected-model" class="section level1">
<h1 class="hasAnchor">
<a href="#how-do-we-use-the-selected-model" class="anchor"></a>How do we use the selected model</h1>
<p>Let’s review were we are. We have build a WRTDS model for TDS below Flaming Gorge Reservoir, but the discharge variable being used in the estimation is not the daily discharge at the sampling site, but is rather the two-year rolling mean discharge at the streamgage upstream of the reservoir. That means the explanatory variable is the 2-year mean discharge at the upstream site computed on the day the sample is collected below the reservoir. (We could have gotten a little more complex here and used a 2-year mean computed a few days before the sample was collected, to compensate for the travel time of the water to the dam, but I didn’t feel that it would make much difference. Perhaps if this was going to be a published study I would do that.) Note also that in the Daily data frame we have also stored the actual discharge for each day at the sampling site below the dam, we call that Qa. We need that, because when we go to compute an estimated flux from the estimated discharge we need the actual discharge at the sampling site and not the 2-year rolling mean.</p>
<p>We can view the concentration trend.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotConcHist.html">plotConcHist</a></span><span class="op">(</span><span class="va">eListRoll</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># but using plotFluxHist() would be meaningless, because the Q variable is the rolling mean and not the daily Q</span></code></pre></div>
<p>Now, we need to fix up the flux results so they reflect the fact that the concentration values need to be multiplied by Qa even though the Q variable we used in the model was the rolling mean from the upstream site. Fortunately, thanks to Laura DeCicco, we have some code that does exactly that.</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">estDailyFromSurfaces_Qa</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span>, <span class="va">localsurfaces</span> <span class="op">=</span> <span class="cn">NA</span>, <span class="va">localDaily</span> <span class="op">=</span> <span class="cn">NA</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="../reference/is.egret.html">is.egret</a></span><span class="op">(</span><span class="va">eList</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/stop.html">stop</a></span><span class="op">(</span><span class="st">"Please check eList argument"</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">localDaily</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estDailyFromSurfaces.html">getSurfaceEstimates</a></span><span class="op">(</span><span class="va">eList</span>, localsurfaces<span class="op">=</span><span class="va">localsurfaces</span>, localDaily <span class="op">=</span> <span class="va">localDaily</span><span class="op">)</span>
  <span class="co"># Calculate "flow-normalized" concentration and flux:</span>
  <span class="va">allLogQsByDayOfYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estDailyFromSurfaces.html">bin_Qs</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">)</span>
  
  <span class="va">concFlux_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estDailyFromSurfaces.html">getConcFluxFromSurface</a></span><span class="op">(</span><span class="va">eList</span>, <span class="va">allLogQsByDayOfYear</span>, localDaily <span class="op">=</span> <span class="va">localDaily</span>, localsurfaces<span class="op">=</span><span class="va">localsurfaces</span><span class="op">)</span>
  
  <span class="va">localDaily</span><span class="op">$</span><span class="va">LogQ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">Qa</span><span class="op">)</span>
  
  <span class="va">allLogQsByDayOfYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/estDailyFromSurfaces.html">bin_Qs</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">)</span>
  <span class="va">allLogQsReplicated</span> <span class="op">&lt;-</span> <span class="va">allLogQsByDayOfYear</span><span class="op">[</span><span class="va">localDaily</span><span class="op">$</span><span class="va">Day</span><span class="op">]</span>
  
  <span class="va">allFluxReplicated</span> <span class="op">&lt;-</span> <span class="va">concFlux_list</span><span class="op">[[</span><span class="st">"allConcReplicated"</span><span class="op">]</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">allLogQsReplicated</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">*</span> <span class="fl">86.4</span>
  
  <span class="co"># Finally bin the collective results by days (the decimal year), and calculate the desired means.</span>
  <span class="va">localDaily</span><span class="op">$</span><span class="va">FNConc</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">concFlux_list</span><span class="op">[[</span><span class="st">"allConcReplicated"</span><span class="op">]</span><span class="op">]</span>, <span class="va">concFlux_list</span><span class="op">[[</span><span class="st">"allDatesReplicated"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">localDaily</span><span class="op">$</span><span class="va">FNFlux</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">allFluxReplicated</span>, <span class="va">concFlux_list</span><span class="op">[[</span><span class="st">"allDatesReplicated"</span><span class="op">]</span><span class="op">]</span>, <span class="st">"mean"</span><span class="op">)</span><span class="op">)</span>
  <span class="va">localDaily</span><span class="op">$</span><span class="va">FluxDay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">ConcDay</span> <span class="op">*</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">Qa</span> <span class="op">*</span> <span class="fl">86.4</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">DailyNew</span> <span class="op">&lt;-</span> <span class="fu">estDailyFromSurfaces_Qa</span><span class="op">(</span><span class="va">eListRoll</span><span class="op">)</span>
<span class="va">INFO</span> <span class="op">&lt;-</span> <span class="va">eListRoll</span><span class="op">$</span><span class="va">INFO</span>
<span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">eListRoll</span><span class="op">$</span><span class="va">Sample</span>
<span class="va">surfaces</span> <span class="op">&lt;-</span> <span class="va">eListRoll</span><span class="op">$</span><span class="va">surfaces</span>
<span class="va">eListNew</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.egret.html">as.egret</a></span><span class="op">(</span><span class="va">INFO</span>, <span class="va">DailyNew</span>, <span class="va">Sample</span>, <span class="va">surfaces</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotConcHist.html">plotConcHist</a></span><span class="op">(</span><span class="va">eListNew</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-9-1.png" width="700"></p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotFluxHist.html">plotFluxHist</a></span><span class="op">(</span><span class="va">eListNew</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-9-2.png" width="700"></p>
<p>We can look at the record in terms of the extent of the trend using tableChange, and also turn out tables of annual results. All of this works as usual.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/tableChange.html">tableChange</a></span><span class="op">(</span><span class="va">eListNew</span>, yearPoints <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1967</span>, <span class="fl">1980</span>, <span class="fl">2000</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##    GREEN RIVER NEAR GREENDALE, UT 
##    Total dissolved solids
##    Water Year 
## 
##            Concentration trends
##    time span       change     slope    change     slope
##                      mg/L   mg/L/yr        %       %/yr
## 
##  1967  to  1980       -79      -6.1       -14      -1.1
##  1967  to  2000      -153      -4.6       -27     -0.83
##  1980  to  2000       -75      -3.7       -15     -0.77
## 
## 
##                  Flux Trends
##    time span          change        slope       change        slope
##                   10^6 kg/yr    10^6 kg/yr /yr      %         %/yr
##  1967  to  1980         -157          -12          -14         -1.1
##  1967  to  2000         -300         -9.1          -27        -0.83
##  1980  to  2000         -143         -7.1          -15        -0.76</code></pre>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/tableResults.html">tableResults</a></span><span class="op">(</span><span class="va">eListNew</span><span class="op">)</span></code></pre></div>
<pre><code>## 
##    GREEN RIVER NEAR GREENDALE, UT 
##    Total dissolved solids
##    Water Year 
## 
##    Year   Discharge    Conc    FN_Conc     Flux    FN_Flux
##              cms            mg/L             10^6 kg/yr 
## 
##    1967      56.5       549       562      1063      1094
##    1968      45.6       529       555      1188      1079
##    1969      49.0       516       548      1240      1063
##    1970      46.6       503       541       827      1049
##    1971      46.0       500       535       635      1035
##    1972      59.1       493       528      1177      1021
##    1973      71.1       482       523      1242      1008
##    1974      60.2       484       517       847       996
##    1975      52.6       483       512      1076       989
##    1976      55.7       485       508      1148       983
##    1977      51.7       484       503      1168       973
##    1978      37.4       532       496       658       959
##    1979      41.5       504       489       840       947
##    1980      47.6       471       484       704       937
##    1981      43.5       481       477       619       925
##    1982      41.4       488       473       735       916
##    1983      57.1       446       468      1669       908
##    1984      77.7       417       465      1306       900
##    1985      68.9       426       462      1035       895
##    1986      57.3       438       459      1344       891
##    1987      65.9       423       456       843       885
##    1988      56.7       437       452       650       876
##    1989      28.1       494       447       460       868
##    1990      24.0       500       444       479       861
##    1991      30.6       482       440       531       854
##    1992      34.5       469       437       657       847
##    1993      30.4       475       433       559       840
##    1994      32.3       466       430       803       834
##    1995      34.9       457       426       637       827
##    1996      42.5       438       423      1032       820
##    1997      57.6       402       419      1024       814
##    1998      63.1       390       416       986       807
##    1999      62.7       387       412      1119       801
##    2000      58.5       391       409       677       794</code></pre>
<p>There are two things of particular note here. One is that in table change it is interesting that the slopes in %/yr are virtually identical for concentration and for flux. That is just what we would expect because it is coming from a lorge body of water and is all in the dissolved phase. The other thing of note is that the discharge values on the tableResults output are not correct. They are the annual average of the rolling mean discharges at the upstream gage. As such, a major drought such as 1977 will not actually show up here until 1978. To get an accurate list one could go all the way back to the original eList for the site (without the upstream flow data) and do a tableResults (using the eListRegular) and the correct discharges would appear there.</p>
</div>
<div id="wrtds-kalman-results" class="section level1">
<h1 class="hasAnchor">
<a href="#wrtds-kalman-results" class="anchor"></a>WRTDS Kalman results</h1>
<p>What if we wanted to come up with the best estimates of concentration or flux on each day (or month or year) in the record (as opposed to doing a trend evaluation)? We can also do a WRTDS_K estimate for these results. This should give us more accuracy. Note that we are only doing this to improve on the concentrations and fluxes. The flow normalized results in this output are not meaningful.</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">eListK</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/WRTDSKalman.html">WRTDSKalman</a></span><span class="op">(</span><span class="va">eListNew</span>, rho <span class="op">=</span> <span class="fl">0.95</span>, niter <span class="op">=</span> <span class="fl">50</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="co"># these next two lines of code are needed to get the proper discharge used in the flux estimates</span>
<span class="va">GenFlux</span> <span class="op">&lt;-</span> <span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span> <span class="op">*</span> <span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">Qa</span> <span class="op">*</span> <span class="fl">86.4</span>
<span class="va">eListK</span><span class="op">$</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span> <span class="op">&lt;-</span> <span class="va">GenFlux</span>
<span class="fu"><a href="../reference/plotWRTDSKalman.html">plotWRTDSKalman</a></span><span class="op">(</span><span class="va">eListK</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-11-1.png" width="700"><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-11-2.png" width="700"></p>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/plotTimeSlice.html">plotTimeSlice</a></span><span class="op">(</span><span class="va">eListK</span>, start <span class="op">=</span> <span class="fl">1982</span>, end <span class="op">=</span> <span class="fl">1987</span>, conc <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="AlternativeQMethod_files/figure-html/unnamed-chunk-11-3.png" width="700"></p>
<p>In this particular case, using the WRTDS_Kalman approach makes very little difference. That’s because the large mixing volume of the reservoir means that concentrations change very little over a period of a few days to a few weeks. I chose to set rho to a very high value to reflect that steadiness of concentration, but it makes very little difference. A little extra coding might be needed to do everything needed to look at the value of the WRTDS_Kalman approach for these types of situations.</p>
</div>
<div id="summary" class="section level1">
<h1 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h1>
<p>For trend results we want to look at the FNConc and FNFlux values that are in eListNew. For the best estimates of concentrations and fluxes for each day (or month or year) of the record we would use the GenConc and GenFlux values in eListK.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert Hirsch, Laura DeCicco.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
