<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Making WRTDS_K flux estimates • EGRET</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Making WRTDS_K flux estimates">
<meta property="og:description" content="EGRET">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-53797708-7"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-53797708-7');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">EGRET</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.0.4.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/EGRET.html">Introduction</a>
</li>
<li>
  <a href="../reference/index.html">Function Help Pages</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Enhancements.html">Enhancements</a>
    </li>
    <li>
      <a href="../articles/WRTDSK.html">WRTDS Kalman</a>
    </li>
    <li>
      <a href="../articles/parallel.html">Running in Parallel</a>
    </li>
    <li>
      <a href="../articles/rResid.html">Random Residuals</a>
    </li>
    <li>
      <a href="../articles/SeasonalFraction.html">Seasonal Analysis</a>
    </li>
    <li>
      <a href="../articles/streamflow_trend.html">Daily Streamflow Trends</a>
    </li>
    <li>
      <a href="../articles/TrendsByMonth.html">Trends by month</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/References_WRTDS.html">Bibliograpy</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/EGRET">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Making%20WRTDS_K%20flux%20estimates_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Making WRTDS_K flux estimates</h1>
                        <h4 class="author">Robert M. Hirsch</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/EGRET/blob/master/vignettes/Making%20WRTDS_K%20flux%20estimates.Rmd"><code>vignettes/Making WRTDS_K flux estimates.Rmd</code></a></small>
      <div class="hidden name"><code>Making WRTDS_K flux estimates.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This document provides a basic set of instructions for calculating WRTDS_K estimates of both concentration and flux (or “load”). It will not give the background or motivation for WRTDS_K. There are now two published papers that lay out the motivation for using this approach, describe the mathematics, and show the results compared to other methods. Those two publications can be found at: <a href="https://pubs.er.usgs.gov/publication/sir20195084" class="uri">https://pubs.er.usgs.gov/publication/sir20195084</a> and <a href="https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2019WR025338" class="uri">https://agupubs.onlinelibrary.wiley.com/doi/full/10.1029/2019WR025338</a> .</p>
<p>The most important thing to know is that these are intended for use for providing the best possible estimates of the actual fluxes on each day, or month, or season, or year in the record. They are not intended for use in evaluating trends (which we would do using flow-normalized flux).</p>
</div>
<div id="what-one-needs-in-order-to-run-this-are-the-following-items" class="section level2">
<h2 class="hasAnchor">
<a href="#what-one-needs-in-order-to-run-this-are-the-following-items" class="anchor"></a>What one needs, in order to run this are the following items:</h2>
<ul>
<li><p>A data set which must already be in the form of an EGRET workspace containing an eList that has all four components of an <strong>eList (INFO, Daily, Sample, surfaces)</strong>. That is, it must be the data and a WRTDS model based on that data that is already estimated. The data set must be in the form of an “.RData” file that contains an <strong>eList</strong>, Nothing else needs to be in that file but if there is other stuff, that’s ok. The discussion and example shown here is carried out on a data set that contains no censored data (“less than values”) and it never has more than one observation on a given day. The description of the method and the examples run in the two papers mentioned are this kind of data set. In the last section of this vignette there will be an explanation of how the method has been generalized to handle these two special cases. The software presented here is able to properly handle data sets that have either or both of these properties (censoring and multiple observations per day).</p></li>
<li><p>There is a set of code (which you will see just below here). You need to copy that block of code into the working directory you will be using. You can give it the name “functionsForK.R” although any name will be ok. When you are ready to run an analysis you will need to source that code. It contains several functions.</p></li>
<li><p>There are four R packages required: <strong>EGRET, lubridate, dplyr, and MASS</strong>. Make sure all of them are loaded on your computer from CRAN.</p></li>
</ul>
<p>Now here is the code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="co">################ you can call this functionsForK.R</span>
<span class="co"># functionsForK is a set of add-ons to EGRET</span>
<span class="co"># for doing the WRTDS_K estimation</span>
<span class="co"># All fuctions (except for one) written by</span>
<span class="co"># Robert M. Hirsch, in 2019</span>
<span class="co"># this file is December 17, 2019</span>
<span class="co">#############################</span>
<span class="co"># makeDailyK</span>
<span class="co">#  This function takes an existing eList </span>
<span class="co">#  Including the estimated model (the surfaces object in the eList)</span>
<span class="co">#  And produces the daily WRTDS_K estimates of concentration and flux</span>
<span class="co"># it requires MASS, EGRET, lubridate, and dplyr</span>
<span class="co">###############################</span>
<span class="va">makeDailyK</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">0.90</span>, <span class="va">niter</span> <span class="op">=</span> <span class="fl">200</span>, <span class="va">seed</span> <span class="op">=</span> <span class="fl">376168</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="va">seed</span><span class="op">)</span>
  <span class="co"># this part is to set up the array of runs of missing values</span>
  <span class="va">localEList</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cleanUp.html">cleanUp</a></span><span class="op">(</span><span class="va">eList</span><span class="op">)</span>
  <span class="va">localDaily</span> <span class="op">&lt;-</span> <span class="fu">populateDailySamp</span><span class="op">(</span><span class="va">localEList</span><span class="op">$</span><span class="va">Daily</span>, <span class="va">localEList</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span>
  <span class="va">numDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>
  <span class="va">numDaysP</span> <span class="op">&lt;-</span> <span class="va">numDays</span> <span class="op">+</span> <span class="fl">1</span>
  <span class="co"># set up DailyGen which will hold the daily generated flux values for all days and all iterations</span>
  <span class="va">DailyGen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">numDays</span> <span class="op">*</span> <span class="va">niter</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">DailyGen</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">numDays</span>, <span class="va">niter</span><span class="op">)</span>
  <span class="co">#   x is a vector of the standardized residuals for each day</span>
  <span class="co">#   most of the elements of x will be NA but those from sampled days will have values</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">stdResid</span>
  <span class="co">#    xP is x that has been padded with a 0 at the start and a 0 at the end</span>
  <span class="co">#    thus it is a vector that always starts and ends with non-missing values</span>
  <span class="va">xP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">x</span>,<span class="fl">0</span><span class="op">)</span>
  <span class="va">zz</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rle.html">rle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">xP</span><span class="op">)</span><span class="op">)</span>
  <span class="co">#    zz$lengths is a vector of run lengths</span>
  <span class="co">#    zz$values is a vector of the values: TRUE means it is a run of missings, </span>
  <span class="co">#       FALSE means it is a run of non-missing values</span>
  <span class="va">nRuns</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">zz</span><span class="op">$</span><span class="va">lengths</span><span class="op">)</span>
  <span class="va">zends</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">zz</span><span class="op">$</span><span class="va">lengths</span><span class="op">)</span>
  <span class="va">nRunsM</span> <span class="op">&lt;-</span> <span class="va">nRuns</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="va">zstarts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">zends</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">nRunsM</span><span class="op">]</span><span class="op">)</span>
  <span class="co"># doGap is the indexs of the runs that are missing values (it is just the even integers)</span>
  <span class="va">doGap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">2</span>,<span class="va">nRunsM</span>,<span class="fl">2</span><span class="op">)</span>
  <span class="co"># numGap is the number of groups of missing values to be filled in</span>
  <span class="va">numGap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">doGap</span><span class="op">)</span>
  <span class="co"># now we are ready to do the iterations to generate the series</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">iter</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">niter</span><span class="op">)</span><span class="op">{</span>
    <span class="va">localEList</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/cleanUp.html">cleanUp</a></span><span class="op">(</span><span class="va">eList</span><span class="op">)</span>
    <span class="co"># this next step adds a trueConc column to Daily, and it is NA if there is no sample value</span>
    <span class="co"># it also adds the stdResid column to Daily</span>
    <span class="va">localDaily</span> <span class="op">&lt;-</span> <span class="fu">populateDailySamp</span><span class="op">(</span><span class="va">localEList</span><span class="op">$</span><span class="va">Daily</span>, <span class="va">localEList</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span>
    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">stdResid</span>
    <span class="co">#    xxP is x that has been padded with a 0 at the start and a 0 at the end</span>
    <span class="co">#    thus it is a vector that always starts and ends with non-missing values</span>
    <span class="va">xxP</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">x</span>,<span class="fl">0</span><span class="op">)</span>
    <span class="co"># now we are going to loop through all the gaps that need to be filled in</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numGap</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">iGap</span><span class="op">&lt;-</span><span class="va">doGap</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>
      <span class="va">startFill</span><span class="op">&lt;-</span><span class="va">zstarts</span><span class="op">[</span><span class="va">iGap</span><span class="op">]</span>
      <span class="va">endFill</span><span class="op">&lt;-</span><span class="va">zends</span><span class="op">[</span><span class="va">iGap</span><span class="op">]</span><span class="op">+</span><span class="fl">1</span>
      <span class="va">nFill</span><span class="op">&lt;-</span><span class="va">zz</span><span class="op">$</span><span class="va">length</span><span class="op">[</span><span class="va">iGap</span><span class="op">]</span><span class="op">+</span><span class="fl">2</span>
      <span class="va">xfill</span><span class="op">&lt;-</span><span class="fu"><a href="../reference/genmissing.html">genmissing</a></span><span class="op">(</span><span class="va">xxP</span><span class="op">[</span><span class="va">startFill</span><span class="op">]</span>,<span class="va">xxP</span><span class="op">[</span><span class="va">endFill</span><span class="op">]</span>,<span class="va">rho</span>,<span class="va">nFill</span><span class="op">)</span>
      <span class="va">xxP</span><span class="op">[</span><span class="va">startFill</span><span class="op">:</span><span class="va">endFill</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">xfill</span><span class="op">}</span>
    <span class="co"># now we need to strip out the padded days</span>
    <span class="va">xResid</span> <span class="op">&lt;-</span> <span class="va">xxP</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="va">numDaysP</span><span class="op">]</span>
    <span class="va">xConc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="op">(</span><span class="va">xResid</span><span class="op">*</span><span class="va">localDaily</span><span class="op">$</span><span class="va">SE</span><span class="op">)</span><span class="op">+</span><span class="va">localDaily</span><span class="op">$</span><span class="va">yHat</span><span class="op">)</span>
    <span class="va">DailyGen</span><span class="op">[</span>,<span class="va">iter</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">xConc</span> <span class="op">*</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">Q</span> <span class="op">*</span> <span class="fl">86.4</span>
  <span class="op">}</span>
  <span class="co"># now we take means over all the iterations</span>
  <span class="va">GenMean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numDays</span><span class="op">)</span>
  <span class="va">Daily</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">Daily</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span> <span class="op">:</span> <span class="va">numDays</span><span class="op">)</span> <span class="op">{</span><span class="va">GenMean</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DailyGen</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span><span class="op">)</span><span class="op">}</span>
  <span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span> <span class="op">&lt;-</span> <span class="va">GenMean</span>
  <span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span> <span class="op">&lt;-</span> <span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span> <span class="op">/</span> <span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">Q</span> <span class="op">*</span> <span class="fl">86.4</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">Daily</span>, <span class="st">"niter"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">niter</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">Daily</span>, <span class="st">"rho"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">rho</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>

<span class="va">genmissing</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">X1</span>,<span class="va">XN</span>,<span class="va">rho</span>,<span class="va">N</span><span class="op">)</span><span class="op">{</span>
  <span class="co"># this code was done by Tim Cohn</span>
  <span class="co">#  X1 is the value before the gap</span>
  <span class="co">#  XN is the value after the gap</span>
  <span class="co">#  rho is the lag one autocorrelation</span>
  <span class="co">#  N is the length of the sequence including X1 and XN </span>
  <span class="co">#     it is two more than the gap length</span>
  <span class="co">#   it requires the MASS package</span>
  <span class="va">C</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/chol.html">chol</a></span><span class="op">(</span><span class="va">rho</span><span class="op">^</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">abs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/outer.html">outer</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>,<span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="st">"-"</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span>,<span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">N</span>,<span class="fl">2</span><span class="op">:</span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>
  <span class="op">(</span><span class="va">C</span><span class="op">%*%</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu">ginv</span><span class="op">(</span><span class="va">C</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">%*%</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">X1</span>,<span class="va">XN</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">N</span><span class="op">-</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">:</span><span class="va">N</span>,<span class="fl">2</span><span class="op">)</span><span class="op">]</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>

<span class="co">####################################</span>
<span class="co"># This function cleans up a Sample data frame</span>
<span class="co"># It randomly picks one sample out of the multiple samples on a given day</span>
<span class="co"># and it makes an augmented record substituting a random value on</span>
<span class="co"># those days with censored data</span>
<span class="co">#  Note, it must have an eList with a valid surfaces matrix </span>
<span class="co"># and the Sample data frame in the eList needs to have yHat and SE already calculated</span>
<span class="co">####################################</span>
<span class="va">cleanUp</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span><span class="op">)</span><span class="op">{</span>
  <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu">random_subset</span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">Sample</span>, <span class="va">Julian</span><span class="op">)</span>
  <span class="va">eListClean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.egret.html">as.egret</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span>, <span class="va">eList</span><span class="op">$</span><span class="va">Daily</span>, <span class="va">Sample</span>, <span class="va">eList</span><span class="op">$</span><span class="va">surfaces</span><span class="op">)</span>
  <span class="va">eListClean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeAugmentedSample.html">makeAugmentedSample</a></span><span class="op">(</span><span class="va">eListClean</span><span class="op">)</span>
  <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">eListClean</span><span class="op">$</span><span class="va">Sample</span>
  <span class="va">Sample</span><span class="op">$</span><span class="va">Uncen</span> <span class="op">&lt;-</span> <span class="fl">1</span>
  <span class="va">Sample</span><span class="op">$</span><span class="va">ConcLow</span> <span class="op">&lt;-</span> <span class="va">Sample</span><span class="op">$</span><span class="va">rObserved</span>
  <span class="va">Sample</span><span class="op">$</span><span class="va">ConcHigh</span> <span class="op">&lt;-</span> <span class="va">Sample</span><span class="op">$</span><span class="va">rObserved</span>
  <span class="va">Sample</span><span class="op">$</span><span class="va">ConcAve</span> <span class="op">&lt;-</span> <span class="va">Sample</span><span class="op">$</span><span class="va">rObserved</span>
  <span class="va">eListClean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/as.egret.html">as.egret</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span>, <span class="va">eList</span><span class="op">$</span><span class="va">Daily</span>, <span class="va">Sample</span>, <span class="va">eList</span><span class="op">$</span><span class="va">surfaces</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">eListClean</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co">####################################</span>
<span class="co"># function written by Laura De Cicco October 2019</span>
<span class="co"># makes a copy of a data frame but when there are</span>
<span class="co"># multiple values with the specified col_name it randomly</span>
<span class="co"># picks one of them and drops the others</span>
<span class="co"># useage newSample &lt;- random_subset(Sample, Julian)</span>
<span class="co">###################################</span>
<span class="va">random_subset</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">col_name</span><span class="op">)</span><span class="op">{</span>
  
  <span class="va">dup_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">col_name</span><span class="op">]</span><span class="op">]</span>, 
                                         fromLast <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/duplicated.html">duplicated</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">col_name</span><span class="op">]</span><span class="op">]</span>, 
                                           fromLast <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">dup_index</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">{</span>
    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="va">dup_index</span> <span class="op">&lt;-</span> <span class="va">dup_index</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">dup_index</span><span class="op">)</span><span class="op">]</span>

  <span class="va">unique_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">col_name</span><span class="op">]</span><span class="op">]</span><span class="op">[</span><span class="va">dup_index</span><span class="op">]</span><span class="op">)</span>
  
  <span class="va">slice_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span><span class="op">(</span><span class="va">unique_groups</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">col_name</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">x</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="op">}</span><span class="op">)</span>
  
  <span class="va">df_dups</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="va">slice_index</span>, <span class="op">]</span> 
  <span class="va">df_no_dups</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">-</span><span class="va">dup_index</span>,<span class="op">]</span>
  
  <span class="va">subDF</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span><span class="va">df_no_dups</span>, <span class="va">df_dups</span><span class="op">)</span>
  <span class="va">subDF</span> <span class="op">&lt;-</span> <span class="va">subDF</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="va">subDF</span><span class="op">[[</span><span class="va">col_name</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,<span class="op">]</span>

  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">subDF</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co">###########################</span>
<span class="va">populateDailySamp</span><span class="op">&lt;-</span><span class="kw">function</span><span class="op">(</span><span class="va">localDaily</span><span class="op">=</span><span class="va">Daily</span>,<span class="va">localSample</span><span class="op">=</span><span class="va">Sample</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">numDays</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">Julian</span><span class="op">)</span>
  <span class="va">numSamp</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">localSample</span><span class="op">$</span><span class="va">Julian</span><span class="op">)</span>
  <span class="va">trueConc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">numDays</span><span class="op">)</span>
  <span class="va">trueFlux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numDays</span><span class="op">)</span>
  <span class="va">stdResid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>,<span class="va">numDays</span><span class="op">)</span>
  <span class="va">DailyOffset</span><span class="op">&lt;-</span><span class="va">localDaily</span><span class="op">$</span><span class="va">Julian</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">-</span><span class="fl">1</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">samp</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numSamp</span><span class="op">)</span><span class="op">{</span><span class="va">iday</span><span class="op">&lt;-</span><span class="va">localSample</span><span class="op">$</span><span class="va">Julian</span><span class="op">[</span><span class="va">samp</span><span class="op">]</span><span class="op">-</span><span class="va">DailyOffset</span>
  <span class="va">trueConc</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span><span class="op">&lt;-</span><span class="va">localSample</span><span class="op">$</span><span class="va">ConcAve</span><span class="op">[</span><span class="va">samp</span><span class="op">]</span>
  <span class="va">trueFlux</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">trueConc</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span> <span class="op">*</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">Q</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span> <span class="op">*</span> <span class="fl">86.4</span>
  <span class="va">stdResid</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span><span class="op">&lt;-</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">trueConc</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span><span class="op">)</span><span class="op">-</span><span class="va">localDaily</span><span class="op">$</span><span class="va">yHat</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="va">localDaily</span><span class="op">$</span><span class="va">SE</span><span class="op">[</span><span class="va">iday</span><span class="op">]</span>
  <span class="op">}</span>
  <span class="va">retDaily</span><span class="op">&lt;-</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">localDaily</span>,<span class="va">trueConc</span>,<span class="va">trueFlux</span>, <span class="va">stdResid</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">retDaily</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="va">setupYearsKalmanFlux</span> <span class="op">&lt;-</span> <span class="kw">function</span> <span class="op">(</span><span class="va">localDaily</span>, <span class="va">paLong</span> <span class="op">=</span> <span class="fl">12</span>, <span class="va">paStart</span> <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> 
<span class="op">{</span>
<span class="co"># note that fluxes returned are the sum of the daily fluxes</span>
<span class="co"># the units on the fluxes are all metric tons </span>
  <span class="va">numDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">MonthSeq</span><span class="op">)</span>
  <span class="va">firstMonthSeq</span> <span class="op">&lt;-</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">MonthSeq</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="va">lastMonthSeq</span> <span class="op">&lt;-</span> <span class="va">localDaily</span><span class="op">$</span><span class="va">MonthSeq</span><span class="op">[</span><span class="va">numDays</span><span class="op">]</span>
  <span class="va">Starts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="va">paStart</span>, <span class="va">lastMonthSeq</span>, <span class="fl">12</span><span class="op">)</span>
  <span class="va">Ends</span> <span class="op">&lt;-</span> <span class="va">Starts</span> <span class="op">+</span> <span class="va">paLong</span> <span class="op">-</span> <span class="fl">1</span>
  <span class="va">StartEndSeq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">Starts</span>, <span class="va">Ends</span><span class="op">)</span>
  <span class="va">StartEndSeq</span> <span class="op">&lt;-</span> <span class="va">StartEndSeq</span><span class="op">[</span><span class="op">(</span><span class="va">StartEndSeq</span><span class="op">$</span><span class="va">Starts</span> <span class="op">&gt;=</span> <span class="va">firstMonthSeq</span><span class="op">)</span> <span class="op">&amp;</span> 
                               <span class="op">(</span><span class="va">StartEndSeq</span><span class="op">$</span><span class="va">Ends</span> <span class="op">&lt;=</span> <span class="va">lastMonthSeq</span><span class="op">)</span>, <span class="op">]</span>
  <span class="va">firstMonth</span> <span class="op">&lt;-</span> <span class="va">StartEndSeq</span><span class="op">[</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span>
  <span class="va">numYears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">StartEndSeq</span><span class="op">$</span><span class="va">Starts</span><span class="op">)</span>
  <span class="va">DecYear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="va">Q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="va">ConcDay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="va">GenConc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="va">FluxDay</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="va">GenFlux</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">numYears</span><span class="op">)</span>
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">numYears</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">startMonth</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">12</span> <span class="op">+</span> <span class="va">firstMonth</span>
    <span class="va">stopMonth</span> <span class="op">&lt;-</span> <span class="va">startMonth</span> <span class="op">+</span> <span class="va">paLong</span> <span class="op">-</span> <span class="fl">1</span>
    <span class="va">DailyYear</span> <span class="op">&lt;-</span> <span class="va">localDaily</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">localDaily</span><span class="op">$</span><span class="va">MonthSeq</span> <span class="op">%in%</span> 
                                    <span class="va">startMonth</span><span class="op">:</span><span class="va">stopMonth</span><span class="op">)</span>, <span class="op">]</span>
    <span class="va">counter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">FluxDay</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">good</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">counter</span><span class="op">)</span><span class="op">)</span>
    <span class="op">}</span>
    <span class="kw">else</span> <span class="op">{</span>
      <span class="va">good</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span>
    <span class="op">}</span>
    <span class="va">DecYear</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">DecYear</span><span class="op">)</span>
    <span class="va">Q</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">Q</span><span class="op">)</span>
    <span class="kw">if</span> <span class="op">(</span><span class="va">good</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">ConcDay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">ConcDay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="va">GenConc</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">GenConc</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
      <span class="va">FluxDay</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">FluxDay</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span>
      <span class="va">GenFlux</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">DailyYear</span><span class="op">$</span><span class="va">GenFlux</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">/</span> <span class="fl">1000</span>
    <span class="op">}</span>
  <span class="op">}</span>
  <span class="va">AnnualResults</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">DecYear</span>, <span class="va">Q</span>, <span class="va">ConcDay</span>, <span class="va">GenConc</span>, <span class="va">FluxDay</span>, <span class="va">GenFlux</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">AnnualResults</span>,<span class="st">"paStart"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">paStart</span>
  <span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">AnnualResults</span>,<span class="st">"paLong"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">paLong</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="va">computeAnnual</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span>, <span class="va">Daily</span>, <span class="va">paStart</span> <span class="op">=</span> <span class="fl">10</span>, <span class="va">paLong</span> <span class="op">=</span> <span class="fl">12</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># it provides a printed list of the annual values and a set of plots</span>
  <span class="co"># if you don't want that output </span>
  <span class="co"># you can get the same thing with AnnualResults &lt;- setupYearsKalmanFlux()</span>
  <span class="co"># This function creates an annual series of results</span>
  <span class="co"># The annual results can be for a specific season, specified by paStart and paLong</span>
  <span class="co"># The default is the water year</span>
  <span class="co"># FluxDay is the traditional regression estimate of Flux</span>
  <span class="co"># GenFlux is the Kalman Filter estimate</span>
  <span class="co"># ConcDay is the traditional regression estimate of Concentration </span>
  <span class="co"># GenConc is the Kalman Filter estimate</span>
  <span class="va">AnnualResults</span> <span class="op">&lt;-</span> <span class="fu">setupYearsKalmanFlux</span><span class="op">(</span><span class="va">Daily</span>, paStart <span class="op">=</span> <span class="va">paStart</span>, paLong <span class="op">=</span> <span class="va">paLong</span><span class="op">)</span>
  <span class="co"># in the print out Q is the annual mean value in m^3/s</span>
  <span class="co"># the two flux values are in metric tons kilograms (1000 kg)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">shortName</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">paramShortName</span><span class="op">)</span>
  <span class="va">period</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"paStart is"</span>,<span class="va">paStart</span>,<span class="st">" paLong is"</span>,<span class="va">paLong</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">period</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">)</span>
  <span class="va">yMax</span> <span class="op">&lt;-</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">FluxDay</span>, <span class="va">AnnualResults</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span>
  <span class="va">nYears</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="co"># first a plot of just the WRTDS estimate</span>
  <span class="va">xMin</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">floor</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">xMax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">[</span><span class="va">nYears</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">xlim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">xMin</span>,<span class="va">xMax</span><span class="op">)</span>
  <span class="va">title1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">shortName</span>,<span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">paramShortName</span>,
                  <span class="st">"\nAnnual Flux Estimates: WRTDS in red, WRTDS-K in green\n"</span>,<span class="va">period</span>,sep<span class="op">=</span><span class="st">"  "</span><span class="op">)</span>
  <span class="va">title2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">shortName</span>,<span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">paramShortName</span>,
                  <span class="st">"\nComparison of the two flux estimates\n"</span>,<span class="va">period</span>,sep<span class="op">=</span><span class="st">"  "</span><span class="op">)</span>
  <span class="co">#</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">AnnualResults</span><span class="op">$</span><span class="va">FluxDay</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">1.3</span>, xlim <span class="op">=</span> <span class="va">xlim</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>,
       ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">"Annual flux, metric tons"</span>, 
       main <span class="op">=</span> <span class="va">title1</span>, las <span class="op">=</span> <span class="fl">1</span>, col <span class="op">=</span> <span class="st">"red"</span>,
       tck <span class="op">=</span> <span class="fl">0.02</span>, cex.main <span class="op">=</span> <span class="fl">1.1</span>, cex.lab <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>new <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">AnnualResults</span><span class="op">$</span><span class="va">GenFlux</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">1.4</span>, col <span class="op">=</span> <span class="st">"green"</span>, xlim <span class="op">=</span> <span class="va">xlim</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>,
       ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, ylab <span class="op">=</span> <span class="st">""</span>, main <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span>, tck <span class="op">=</span> <span class="fl">0.02</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="co"># scatter plot</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">$</span><span class="va">FluxDay</span>, <span class="va">AnnualResults</span><span class="op">$</span><span class="va">GenFlux</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">1.3</span>, col <span class="op">=</span> <span class="st">"red"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">)</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>,
       ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">yMax</span><span class="op">)</span>, las <span class="op">=</span> <span class="fl">1</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">"WRTDS estimate of annual flux, in metric tons"</span>, ylab <span class="op">=</span> 
         <span class="st">"WRTDS_K estimate of annual flux, in metric tons"</span>, cex.main <span class="op">=</span> <span class="fl">1.1</span>, cex.lab <span class="op">=</span> <span class="fl">0.95</span>, cex.axis <span class="op">=</span> <span class="fl">1.2</span>, 
       main <span class="op">=</span> <span class="va">title2</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">0</span>, b <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">AnnualResults</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="va">plotTimeSlice</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span>, <span class="va">Daily</span>, <span class="va">start</span>, <span class="va">end</span><span class="op">)</span><span class="op">{</span>
  <span class="va">Daily</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span><span class="op">(</span><span class="va">Daily</span>,<span class="va">DecYear</span> <span class="op">&gt;=</span> <span class="va">start</span> <span class="op">&amp;</span> <span class="va">DecYear</span> <span class="op">&lt;=</span> <span class="va">end</span><span class="op">)</span>
  <span class="va">concHigh</span> <span class="op">&lt;-</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">trueConc</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">ConcDay</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">concLow</span> <span class="op">&lt;-</span> <span class="fl">0.9</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">trueConc</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">ConcDay</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">fluxHigh</span> <span class="op">&lt;-</span> <span class="fl">1.1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">trueFlux</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">FluxDay</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="va">fluxLow</span> <span class="op">&lt;-</span> <span class="fl">0.9</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">trueFlux</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span>,<span class="va">Daily</span><span class="op">$</span><span class="va">FluxDay</span>,na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="co"># figure out which data symbol to use, red for uncensored, brown for censored</span>
  <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">Uncen</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"red"</span>, <span class="st">"cyan4"</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>tck <span class="op">=</span> <span class="fl">0.02</span>, las <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
  <span class="co"># first concentration, then flux</span>
  <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">shortName</span>, <span class="va">eList</span><span class="op">$</span><span class="va">INFO</span><span class="op">$</span><span class="va">paramShortName</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
  <span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">ConcDay</span><span class="op">)</span>
  <span class="va">fratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">ratio</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">concTitle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">name</span>,<span class="st">"\nConcentrations, Black is WRTDS, Green is WRTDS_K\nData in red, (rl in blue if &lt;), Ratio of means is"</span>, <span class="va">fratio</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
  
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">Daily</span><span class="op">$</span><span class="va">ConcDay</span>, log <span class="op">=</span> <span class="st">"y"</span>, type <span class="op">=</span> <span class="st">"l"</span>, las <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, 
       xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">concLow</span>,<span class="va">concHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, cex.main <span class="op">=</span> <span class="fl">0.9</span>, 
       ylab <span class="op">=</span> <span class="st">"Concentration, in milligrams per Liter"</span>,
       main <span class="op">=</span> <span class="va">concTitle</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>new <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">ConcHigh</span>, log <span class="op">=</span> <span class="st">"y"</span>, pch <span class="op">=</span> <span class="fl">20</span>, cex <span class="op">=</span> <span class="fl">1.1</span>, col <span class="op">=</span> <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">color</span>, 
       xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">concLow</span>,<span class="va">concHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>,
       ylab <span class="op">=</span> <span class="st">""</span>, main <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>new <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">Daily</span><span class="op">$</span><span class="va">GenConc</span>, log <span class="op">=</span> <span class="st">"y"</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, 
       xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">concLow</span>,<span class="va">concHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, col <span class="op">=</span> <span class="st">"green"</span>, 
       ylab <span class="op">=</span> <span class="st">""</span>, main <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="co"># flux graph</span>
  <span class="va">ratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">FluxDay</span><span class="op">)</span>
  <span class="va">fratio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/format.html">format</a></span><span class="op">(</span><span class="va">ratio</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
  <span class="va">fluxTitle</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">name</span>,<span class="st">"\nFlux, Black is WRTDS, Green is WRTDS_K\nData in red, (rl in blue if &lt;), Ratio of means is"</span>, <span class="va">fratio</span>, sep <span class="op">=</span> <span class="st">" "</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">Daily</span><span class="op">$</span><span class="va">FluxDay</span>, log <span class="op">=</span> <span class="st">"y"</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, 
       xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fluxLow</span>,<span class="va">fluxHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, las <span class="op">=</span> <span class="fl">1</span>,  
       ylab <span class="op">=</span> <span class="st">"Flux, in kg per day"</span>, cex.main <span class="op">=</span> <span class="fl">0.95</span>,
       main <span class="op">=</span> <span class="va">fluxTitle</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>new <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">ConcHigh</span> <span class="op">*</span> <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">Q</span> <span class="op">*</span> <span class="fl">86.4</span>, log <span class="op">=</span> <span class="st">"y"</span>, pch <span class="op">=</span> <span class="fl">20</span>, 
       cex <span class="op">=</span> <span class="fl">1.1</span>, col <span class="op">=</span> <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span><span class="op">$</span><span class="va">color</span>, 
       xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fluxLow</span>,<span class="va">fluxHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>,
       ylab <span class="op">=</span> <span class="st">""</span>, main <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>new <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">Daily</span><span class="op">$</span><span class="va">DecYear</span>, <span class="va">Daily</span><span class="op">$</span><span class="va">GenFlux</span>, log <span class="op">=</span> <span class="st">"y"</span>, type <span class="op">=</span> <span class="st">"l"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">end</span><span class="op">)</span>, 
       xaxs <span class="op">=</span> <span class="st">"i"</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">fluxLow</span>,<span class="va">fluxHigh</span><span class="op">)</span>, yaxs <span class="op">=</span> <span class="st">"i"</span>, xlab <span class="op">=</span> <span class="st">""</span>, col <span class="op">=</span> <span class="st">"green"</span>, 
       ylab <span class="op">=</span> <span class="st">""</span>, main <span class="op">=</span> <span class="st">""</span>, axes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="op">}</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co">#</span>
<span class="co"># script for identifying if a Sample data frame has</span>
<span class="co"># any days with multiple samples</span>
<span class="co"># or any samples that are uncensored</span>
<span class="va">specialCase</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">eList</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">eList</span><span class="op">$</span><span class="va">Sample</span>
  <span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">$</span><span class="va">Date</span><span class="op">)</span>
  <span class="va">days</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">$</span><span class="va">Julian</span><span class="op">)</span>
  <span class="va">nDays</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">days</span><span class="op">)</span>
  <span class="va">mult</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">n</span> <span class="op">&gt;</span> <span class="va">nDays</span><span class="op">)</span> <span class="cn">TRUE</span> <span class="kw">else</span> <span class="cn">FALSE</span>
  <span class="va">nUncen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">Sample</span><span class="op">$</span><span class="va">Uncen</span><span class="op">)</span>
  <span class="va">cen</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="va">nUncen</span> <span class="op">&lt;</span> <span class="va">n</span><span class="op">)</span> <span class="cn">TRUE</span> <span class="kw">else</span> <span class="cn">FALSE</span>
  <span class="co"># when mult is TRUE, needs to go through the subsampling process each time</span>
  <span class="co"># when cen is TRUE it needs to go through the random augmentation </span>
  <span class="va">special</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">mult</span>, <span class="va">cen</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">special</span><span class="op">)</span>
<span class="op">}</span></pre></div>
</div>
<div id="running-the-software" class="section level2">
<h2 class="hasAnchor">
<a href="#running-the-software" class="anchor"></a>Running the software</h2>
<p>Make sure that the <strong>.RData</strong> file and the code are in the workspace you want to work in and that you have properly set the working directory with the <strong>setwd()</strong> command. Be sure that the eList contains the <strong>surfaces</strong> matrix, which is the estimated WRTDS model, based on the data set in the <strong>Sample</strong> data frame. Here is an example of a run, with some comments along the way. The actual commands are shown in the shaded part.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://pubs.usgs.gov/tm/04/a10/">EGRET</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.stats.ox.ac.uk/pub/MASS4/">MASS</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></pre></div>
<pre><code>## 
## Attaching package: 'lubridate'</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     date, intersect, setdiff, union</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></pre></div>
<pre><code>## 
## Attaching package: 'dplyr'</code></pre>
<pre><code>## The following object is masked from 'package:MASS':
## 
##     select</code></pre>
<pre><code>## The following objects are masked from 'package:stats':
## 
##     filter, lag</code></pre>
<pre><code>## The following objects are masked from 'package:base':
## 
##     intersect, setdiff, setequal, union</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"rockCr.tp.RData"</span><span class="op">)</span> <span class="co"># the name of your EGRET workspace</span>
<span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"functionsForK.R"</span><span class="op">)</span>
<span class="co"># now we will run the WRTDS_K estimation (I'm using the defaults for now)</span>
<span class="va">DailyK</span> <span class="op">&lt;-</span> <span class="fu">makeDailyK</span><span class="op">(</span><span class="va">eList</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">DailyK</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>##       Date                  Q                 Julian          Month       
##  Min.   :2006-01-01   Min.   : 0.001699   Min.   :56978   Min.   : 1.000  
##  1st Qu.:2009-03-09   1st Qu.: 0.024352   1st Qu.:58142   1st Qu.: 3.000  
##  Median :2012-05-16   Median : 0.053094   Median :59306   Median : 6.000  
##  Mean   :2012-05-16   Mean   : 0.177447   Mean   :59306   Mean   : 6.435  
##  3rd Qu.:2015-07-24   3rd Qu.: 0.129974   3rd Qu.:60469   3rd Qu.: 9.000  
##  Max.   :2018-09-30   Max.   :16.140602   Max.   :61633   Max.   :12.000  
##                                                                           
##       Day           DecYear        MonthSeq      waterYear   
##  Min.   :  1.0   Min.   :2006   Min.   :1873   Min.   :2006  
##  1st Qu.: 91.0   1st Qu.:2009   1st Qu.:1911   1st Qu.:2009  
##  Median :180.0   Median :2012   Median :1949   Median :2012  
##  Mean   :181.1   Mean   :2012   Mean   :1949   Mean   :2012  
##  3rd Qu.:270.0   3rd Qu.:2016   3rd Qu.:1987   3rd Qu.:2015  
##  Max.   :366.0   Max.   :2019   Max.   :2025   Max.   :2018  
##                                                              
##   Qualifier               i             LogQ              Q7          
##  Length:4656        Min.   :   1   Min.   :-6.378   Min.   :0.003681  
##  Class :character   1st Qu.:1165   1st Qu.:-3.715   1st Qu.:0.034031  
##  Mode  :character   Median :2328   Median :-2.936   Median :0.076759  
##                     Mean   :2328   Mean   :-2.806   Mean   :0.177639  
##                     3rd Qu.:3492   3rd Qu.:-2.040   3rd Qu.:0.178184  
##                     Max.   :4656   Max.   : 2.781   Max.   :3.300126  
##                                                     NA's   :6         
##       Q30                yHat              SE            ConcDay       
##  Min.   :0.007145   Min.   :-2.848   Min.   :0.2977   Min.   :0.06238  
##  1st Qu.:0.049918   1st Qu.:-2.143   1st Qu.:0.3661   1st Qu.:0.12879  
##  Median :0.111814   Median :-1.817   Median :0.4203   Median :0.17797  
##  Mean   :0.178359   Mean   :-1.733   Mean   :0.4572   Mean   :0.26460  
##  3rd Qu.:0.234119   3rd Qu.:-1.468   3rd Qu.:0.5320   3rd Qu.:0.26421  
##  Max.   :1.354904   Max.   : 1.358   Max.   :0.7834   Max.   :5.39851  
##  NA's   :29                                                            
##     FluxDay             FNConc            FNFlux            GenFlux        
##  Min.   :   0.014   Min.   :0.09381   Min.   :  0.4727   Min.   :   0.014  
##  1st Qu.:   0.282   1st Qu.:0.16312   1st Qu.:  1.3266   1st Qu.:   0.284  
##  Median :   0.704   Median :0.23973   Median :  4.0625   Median :   0.681  
##  Mean   :  19.701   Mean   :0.26303   Mean   : 19.3821   Mean   :  17.837  
##  3rd Qu.:   2.699   3rd Qu.:0.33200   3rd Qu.: 14.4545   3rd Qu.:   2.373  
##  Max.   :6929.255   Max.   :0.81444   Max.   :545.3019   Max.   :6936.258  
##                                                                            
##     GenConc      
##  Min.   :0.0500  
##  1st Qu.:0.1217  
##  Median :0.1715  
##  Mean   :0.2482  
##  3rd Qu.:0.2417  
##  Max.   :6.9288  
## </code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">DailyK</span>,<span class="st">"niter"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 200</code></pre>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">DailyK</span>,<span class="st">"rho"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.9</code></pre>
<p>The object being created here is a data frame called <strong>DailyK</strong>. It looks just like <strong>Daily</strong> but with some columns added. What are the extra columns?</p>
<p><strong>trueConc</strong> is the measured concentration on the days when there is a value, many will be NA</p>
<p><strong>trueFlux</strong> (in kg/day) flux for the days when concentration is measured</p>
<p><strong>stdResid</strong> (dimensionless) this is the standardized residual from the WRTDS model estimate, for the days when concentration is measured. It is (ln(trueConc) - yHat) / SE.</p>
<p><strong>yHat</strong> is the WRTDS estimate of the natural log of concentration and SE is the standard error of the WRTDS model for the specific time, discharge, and season.</p>
<p><strong>GenFlux</strong> is the WRTDS_K estimate of the flux for each day (in kg/day) <strong>GenConc</strong> is the WRTDS_K estimate of the concentration for each day (in kg/day)</p>
</div>
<div id="summarizing-results-at-an-annual-time-step" class="section level1">
<h1 class="hasAnchor">
<a href="#summarizing-results-at-an-annual-time-step" class="anchor"></a>Summarizing results at an annual time step</h1>
<p>Now we can take the results from the <strong>DailyK</strong> data frame and compute annual flux values. We will do that for the regular WRTDS and for WRTDS_K (using the data in two columns of <strong>DailyK</strong> the <strong>FluxDay</strong> column and the <strong>GenFlux</strong> column). We can also do these computations for some period of analysis other than the water year, but for now, we will just show the water year computations. The function used is called <strong>computeAnnual</strong> and it produces a data frame called <strong>AnnualResults</strong> and also produces some graphics that show the two types of results. Notice that <strong>AnnualResults</strong> has some attributes that go with it that will tell you what the period of analysis was. They are printed here. Note that the function <strong>computeAnnual</strong> actually does more than the computations, it prints out the content of AnnualResults and it also makes two graphs that tell you some things about how the two types of estimates compare to each other.</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="va">AnnualResults</span> <span class="op">&lt;-</span> <span class="fu">computeAnnual</span><span class="op">(</span><span class="va">eList</span>, Daily <span class="op">=</span> <span class="va">DailyK</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Rock Creek at Kentucky Road in Independence, MO"
## [1] "Phosphorus"
## [1] "paStart is 10  paLong is 12"
##     DecYear          Q   ConcDay   GenConc   FluxDay   GenFlux
## 1  2007.247 0.17898031 0.2962950 0.3035116 10.503918 11.412228
## 2  2008.248 0.27055586 0.3516980 0.3027088 16.375702 14.377783
## 3  2009.247 0.26025897 0.3759310 0.3822140  9.550358  9.926332
## 4  2010.247 0.27538327 0.3747984 0.3130897  8.891109  7.960983
## 5  2011.247 0.14896523 0.2471670 0.2414275  5.124139  4.921882
## 6  2012.248 0.08488400 0.1868972 0.1980234  1.476794  1.548080
## 7  2013.247 0.13601784 0.2226408 0.1978812  3.398696  2.656734
## 8  2014.247 0.10545581 0.1980464 0.1976627  3.090438  3.171315
## 9  2015.247 0.20777738 0.2707080 0.2217504  8.453969  6.268860
## 10 2016.248 0.25410346 0.2935102 0.2302717  8.170745  5.707152
## 11 2017.247 0.19541107 0.2342773 0.2421715 12.077357 10.410761
## 12 2018.247 0.09552708 0.1734324 0.1714012  3.436251  3.403874</code></pre>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-3-1.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<div class="sourceCode" id="cb18"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">AnnualResults</span>, <span class="st">"paStart"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 10</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">AnnualResults</span>, <span class="st">"paLong"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 12</code></pre>
<p>The content of <strong>AnnualResults</strong> is fairly obvious.</p>
<p><strong>DecYear</strong> is the mean day of the year for the period of analysis, for example, water year 2007 would have a mean day of 2007.247 (end of March of 2007).</p>
<p><strong>Q</strong> is the mean discharge in m^3/s.</p>
<p><strong>ConcDay</strong> is the mean value of concentration for the year from the regular WRTDS model, in mg/L.</p>
<p><strong>GenConc</strong> is the mean value of concentration for the year from the WRTDS_K model, in mg/L.</p>
<p><strong>FluxDay</strong> is the sum of the daily flux values from the regular WRTDS model, in units of metric tons (same as 10^3 kg).</p>
<p><strong>GenFlux</strong> is the sum of the daily flux values from the WRTDS_K model, in units of metric tons (same as 10^3 kg).</p>
<p>The first graph compares the time series of the two flux records: WRTDS in red and WRTDS_K in green. This graph is fairly typical of what we have seen in a number of studies so far. There are a number of years in which the two estimates are practically identical (e.g. 2011, 2012, 2014) but there are a few cases where they diverge significantly. In this example, in those cases the WRTDS_K estimate is substantially lower than the WRTDS estimate. What that means is that the tendency for WRTDS to predict values that are too high has been reduced. It happens that the flux bias statistic for this data set is 0.35, suggesting that the model has a tendency to estimate fluxes that are too high.</p>
<p>The second graph is just another way to look at these same results, but as a scatter plot of results from the two methods. What we see is a tendency for a fair number of years to plot close to the 1:1 line but four of them are substantially below the line (meaning their WRTDS_K estimates are lower than their WRTDS estimates).</p>
<p>Seeing this, we’d like to dig in a bit and see what’s going on.</p>
</div>
<div id="looking-at-parts-of-the-record-to-see-how-wrtds-and-wrtds_k-are-working" class="section level1">
<h1 class="hasAnchor">
<a href="#looking-at-parts-of-the-record-to-see-how-wrtds-and-wrtds_k-are-working" class="anchor"></a>Looking at parts of the record to see how WRTDS and WRTDS_K are working</h1>
<p>We have a function that produces graphics that show, as a time series, the daily true values (for the days that have samples), the WRTDS estimates for every day, and the WRTDS_K estimates for every day. We could plot the whole record, but the ups and downs of the curves would be so tight that we really couldn’t see what’s going on. So, we let the user pick a time slice to look at. It produces two plots, the first is for concentration (it is typically easier to see what is happening in the estimation with the concentration graphs) and the second is for flux (discharge plays such a big role here that the propagation of error from the concentrations gets somewhat obscured, but flux is, after all, what we are interested in here).</p>
<p>We will look at two examples here, in each case looking at about a half a year. The first one (2018) is a year in which there was very good agreement between the estimates, and the second one (2015) is a year with a large difference between the methods. Let’s see what those results look like.</p>
<div class="sourceCode" id="cb22"><pre class="downlit">
<span class="fu"><a href="../reference/plotTimeSlice.html">plotTimeSlice</a></span><span class="op">(</span><span class="va">eList</span>, Daily <span class="op">=</span> <span class="va">DailyK</span>, start <span class="op">=</span> <span class="fl">2018.2</span>, end <span class="op">=</span> <span class="fl">2018.7</span><span class="op">)</span></pre></div>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-4-1.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-4-2.png" width="700"></p>
<div class="sourceCode" id="cb23"><pre class="downlit">
<span class="fu"><a href="../reference/plotTimeSlice.html">plotTimeSlice</a></span><span class="op">(</span><span class="va">eList</span>, Daily <span class="op">=</span> <span class="va">DailyK</span>, start <span class="op">=</span> <span class="fl">2015.2</span>, end <span class="op">=</span> <span class="fl">2015.7</span><span class="op">)</span></pre></div>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-4-3.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-4-4.png" width="700"></p>
<p>What can we learn from these figures? The first, which is a half year in 2018. Note before we start that all of these graphs show either concentration or flux on a log scale. We will start with the concentration graph. We see that there are 7 observed values. When we compare the observed values (red dots) with the WRTDS estimates (black line) for each of those days we see two negative residuals followed by a positive residual a negative a positive and the final two have residuals that are close to zero. Once we get past the second observation (around 2018.25) we see the WRTDS_K curve (in green) going back a forth from being a little above the WRTDS curve to a little below. This alternation indicates that the errors of the model are not ones that persist for very many days and thus the corrections based on these errors don’t persist for very many days. One other thing to note is that the model suggests a big spike in concentration around 2018.4 but there are no samples very close in time to this event (there is a gap of about a month) and the big discharge event took place about half way between these two sample dates. Given this lack of information close to the date of the large flow event, the WRTDS_K will not result in much of a change during this event as compared to what we estimate from WRTDS. The upshot of all of this is that the residuals information doesn’t make much difference during this half year in WRTDS_K results and we really don’t change our estimate by much.</p>
<p>Now, contrast this with the 2015 results. Here we see the first residual being very near zero, but after that every one of them is substantially negative (below the black line). What this is telling us is that something was going on in this part of 2015 such that concentrations were always lower than the WRTDS model (based on the years around 2015, both before and after). We don’t happen to know why this departure exists (perhaps it relates to what tributaries were most active or to something about antecedent conditions). What it does tell us is that generally, throughout the period 2015.35 through 2015.65 it is a good guess that concentrations are likely to have been lower than what the WRTDS model estimates they should be. The math of the WRTDS_K model ends up giving us a green curve that is always below the black curve throughout this period. That means, when the WRTDS_K estimate is summarized for the whole 2015 water year it will be a good deal lower than what WRTDS would give us. Looking at the last of the four graphs (for flux), even though the black and green curves track pretty close to each other the ratio of the two mean fluxes is 0.45. So, the persistant negative residuals causes us to make a major downward adjustment to our estimated flux for the period.</p>
<p>As a generalization we can say that WRTDS_K will result in large adjustments when two things happen: 1) there is a strong persistence of the residuals (long runs of positives or long runs of negatives), and 2) when there are samples collected on or close to the days of maximum flux and they show large absolute residuals.</p>
<p>One final note. These graphs also have an additional bit of information. They say, in their title “Ratio of means is xx”. This ratio is specific to the time slice shown in the plot (not the whole record being estimated) and the ratio stated is WRTDS_K estimate divided by the regular WRTDS estimate.</p>
</div>
<div id="two-options-available-setting-rho-and-setting-niter" class="section level1">
<h1 class="hasAnchor">
<a href="#two-options-available-setting-rho-and-setting-niter" class="anchor"></a>Two options available (setting rho and setting niter)</h1>
<p>One of the things that the user must select is the rho value. We don’t have a strong theoretical basis for selecting the right value of rho, although our research has shown that the results are not highly sensitive to it. In the paper published in Zhang and Hirsch (2019) (see the second URL near the start of this document) we do make some generalizations about the selection of rho. We found that for nitrate a slightly higher rho value (such as 0.95) may be better than for other constitutents such as TP, OrthoP, Suspended Sediment, or Chloride for which values like 0.85 or 0.9 may be better. The somewhat different behavior for nitrate is explained by the fact that at many sites there are some other factors probably related to denitrification the discharge and term does not have a great amount of explanatory power in the WRTDS model. As such, placing more reliance on the results of samples that are close in time is appropriate. One can experiment with different values of rho because it is an argument in the <strong>makeDailyK</strong> function.</p>
<p>We can re-run the analysis with rho of 0.85 and see how much difference it makes. The table shown here lists the ratio the difference in annual values divided by the original annual value (so multiplying these numbers by 100 would result in differences in percent).</p>
<div class="sourceCode" id="cb24"><pre class="downlit">
<span class="va">DailyK2</span> <span class="op">&lt;-</span> <span class="fu">makeDailyK</span><span class="op">(</span><span class="va">eList</span>, rho <span class="op">=</span> <span class="fl">0.85</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">DailyK2</span>,<span class="st">"rho"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 0.85</code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">DailyK2</span>,<span class="st">"niter"</span><span class="op">)</span><span class="op">)</span></pre></div>
<pre><code>## [1] 200</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit">
<span class="va">AnnualResults2</span> <span class="op">&lt;-</span> <span class="fu">computeAnnual</span><span class="op">(</span><span class="va">eList</span>, Daily <span class="op">=</span> <span class="va">DailyK2</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Rock Creek at Kentucky Road in Independence, MO"
## [1] "Phosphorus"
## [1] "paStart is 10  paLong is 12"
##     DecYear          Q   ConcDay   GenConc   FluxDay   GenFlux
## 1  2007.247 0.17898031 0.2962950 0.3047198 10.503918 11.484281
## 2  2008.248 0.27055586 0.3516980 0.3155029 16.375702 15.238110
## 3  2009.247 0.26025897 0.3759310 0.3805880  9.550358  9.948663
## 4  2010.247 0.27538327 0.3747984 0.3312658  8.891109  8.274015
## 5  2011.247 0.14896523 0.2471670 0.2415491  5.124139  4.951591
## 6  2012.248 0.08488400 0.1868972 0.1960336  1.476794  1.553370
## 7  2013.247 0.13601784 0.2226408 0.2028929  3.398696  2.789326
## 8  2014.247 0.10545581 0.1980464 0.1980895  3.090438  3.192825
## 9  2015.247 0.20777738 0.2707080 0.2330521  8.453969  6.511406
## 10 2016.248 0.25410346 0.2935102 0.2449645  8.170745  6.163219
## 11 2017.247 0.19541107 0.2342773 0.2421669 12.077357 10.879251
## 12 2018.247 0.09552708 0.1734324 0.1716476  3.436251  3.333916</code></pre>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-5-1.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-5-2.png" width="700"></p>
<div class="sourceCode" id="cb30"><pre class="downlit">
<span class="va">Ratios</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">AnnualResults2</span> <span class="op">-</span> <span class="va">AnnualResults</span><span class="op">)</span> <span class="op">/</span> <span class="va">AnnualResults</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">Ratios</span><span class="op">)</span></pre></div>
<pre><code>##    DecYear Q ConcDay       GenConc FluxDay      GenFlux
## 1        0 0       0  0.0039807650       0  0.006313677
## 2        0 0       0  0.0422655465       0  0.059837223
## 3        0 0       0 -0.0042540636       0  0.002249681
## 4        0 0       0  0.0580542534       0  0.039320859
## 5        0 0       0  0.0005039279       0  0.006035998
## 6        0 0       0 -0.0100482896       0  0.003416747
## 7        0 0       0  0.0253266865       0  0.049907775
## 8        0 0       0  0.0021594544       0  0.006782641
## 9        0 0       0  0.0509659590       0  0.038690539
## 10       0 0       0  0.0638065343       0  0.079911354
## 11       0 0       0 -0.0000189604       0  0.045000568
## 12       0 0       0  0.0014377375       0 -0.020552659</code></pre>
<p>What we see here is that the change in rho from 0.9 to 0.85 makes less than a 10% difference in any of the years.</p>
<p>Setting the number of iterations to 200 (the default) seems to be sufficient. We can set a different random number seed and see how much difference it makes in the results.</p>
<div class="sourceCode" id="cb32"><pre class="downlit">
<span class="va">DailyK2</span> <span class="op">&lt;-</span> <span class="fu">makeDailyK</span><span class="op">(</span><span class="va">eList</span>, seed <span class="op">=</span> <span class="fl">38109695</span><span class="op">)</span>
<span class="va">AnnualResults2</span> <span class="op">&lt;-</span> <span class="fu">computeAnnual</span><span class="op">(</span><span class="va">eList</span>, Daily <span class="op">=</span> <span class="va">DailyK2</span><span class="op">)</span></pre></div>
<pre><code>## [1] "Rock Creek at Kentucky Road in Independence, MO"
## [1] "Phosphorus"
## [1] "paStart is 10  paLong is 12"
##     DecYear          Q   ConcDay   GenConc   FluxDay   GenFlux
## 1  2007.247 0.17898031 0.2962950 0.2980348 10.503918 11.420844
## 2  2008.248 0.27055586 0.3516980 0.2984355 16.375702 13.639404
## 3  2009.247 0.26025897 0.3759310 0.3835593  9.550358  9.856361
## 4  2010.247 0.27538327 0.3747984 0.3086841  8.891109  7.732880
## 5  2011.247 0.14896523 0.2471670 0.2434325  5.124139  5.075688
## 6  2012.248 0.08488400 0.1868972 0.1973845  1.476794  1.524699
## 7  2013.247 0.13601784 0.2226408 0.1964867  3.398696  2.680148
## 8  2014.247 0.10545581 0.1980464 0.1989881  3.090438  3.233255
## 9  2015.247 0.20777738 0.2707080 0.2202788  8.453969  6.200197
## 10 2016.248 0.25410346 0.2935102 0.2269377  8.170745  5.508252
## 11 2017.247 0.19541107 0.2342773 0.2452966 12.077357 11.080569
## 12 2018.247 0.09552708 0.1734324 0.1748340  3.436251  3.781166</code></pre>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-6-1.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-6-2.png" width="700"></p>
<div class="sourceCode" id="cb34"><pre class="downlit">
<span class="va">Ratios</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">AnnualResults2</span> <span class="op">-</span> <span class="va">AnnualResults</span><span class="op">)</span> <span class="op">/</span> <span class="va">AnnualResults</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">Ratios</span><span class="op">)</span></pre></div>
<pre><code>##    DecYear Q ConcDay      GenConc FluxDay       GenFlux
## 1        0 0       0 -0.018044719       0  0.0007550509
## 2        0 0       0 -0.014116740       0 -0.0513555957
## 3        0 0       0  0.003519725       0 -0.0070490952
## 4        0 0       0 -0.014071164       0 -0.0286525439
## 5        0 0       0  0.008304999       0  0.0312493314
## 6        0 0       0 -0.003226711       0 -0.0151033182
## 7        0 0       0 -0.007047291       0  0.0088131734
## 8        0 0       0  0.006705153       0  0.0195312846
## 9        0 0       0 -0.006636557       0 -0.0109529811
## 10       0 0       0 -0.014478648       0 -0.0348510967
## 11       0 0       0  0.012904366       0  0.0643381003
## 12       0 0       0  0.020027964       0  0.1108416945</code></pre>
<p>This table shows us that, at worst the individual annual fluxes differ by about 11% and many of them differ by less than 2% in successive runs with different seeds The annual concentrations never differ by more than about 2%. This suggests that 200 is a sufficient number of iterations to run to obtain a stable result. For final calculations for publication one might want to specify niter = 500 or niter = 1000 in the call to <strong>makeDailyK</strong>, but the idea here is not perfection, but rather to make a reasonable adjustment of the flux record to account for the serial correlation of the residuals.</p>
</div>
<div id="what-about-putting-these-results-into-the-plotconchist-or-plotfluxhist-graphs" class="section level1">
<h1 class="hasAnchor">
<a href="#what-about-putting-these-results-into-the-plotconchist-or-plotfluxhist-graphs" class="anchor"></a>What about putting these results into the <strong>plotConcHist</strong> or <strong>plotFluxHist</strong> graphs</h1>
<p>Typically when we do some type of trend study we may want to create graphic outputs showing the Flow Normalized values (connected by a line) and the estimated annual values (as dots). If you want to put the WRTDS_K values on these graphs you can use some substitute functions.</p>
<p><strong>plotConcHistK</strong> works exactly like <strong>plotConcHist</strong> but there is a new second argument, it is <strong>DailyK</strong>. So in it’s simplest form the call would be <strong>plotConcHistK(eList, DailyK)</strong>. The markings in the title have a <em>(K)</em> after the word <em>Estimates</em>.</p>
<p><strong>plotFluxHistK</strong> works exactly like <strong>plotFluxHist</strong> but there is a new second argument, it is <strong>DailyK</strong>. So in it’s simplest form the call would be <strong>plotFluxHistK(eList, DailyK)</strong>. The markings in the title have a <em>(K)</em> after the word <em>Estimates</em>.</p>
<p>Here they are being used.</p>
<div class="sourceCode" id="cb36"><pre class="downlit">
<span class="fu">plotConcHistK</span><span class="op">(</span><span class="va">eList</span>, <span class="va">DailyK</span><span class="op">)</span></pre></div>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb37"><pre class="downlit">
<span class="fu">plotFluxHistK</span><span class="op">(</span><span class="va">eList</span>, <span class="va">DailyK</span>, fluxUnit <span class="op">=</span> <span class="fl">8</span><span class="op">)</span></pre></div>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-7-2.png" width="700"></p>
</div>
<div id="operationalizing-this-in-a-batch-job" class="section level1">
<h1 class="hasAnchor">
<a href="#operationalizing-this-in-a-batch-job" class="anchor"></a>Operationalizing this in a batch job</h1>
<p>The process after loading the necessary packages and the functionsForK code is this.</p>
<ul>
<li>load the workspace for a site</li>
<li>give the command <strong>DailyK &lt;- makeDailyK(eList)</strong>
</li>
<li>give the command <strong>AnnualResults &lt;- computeAnnual(eList, Daily = DailyK)</strong>
</li>
<li>then save the object <strong>AnnualResults</strong>
</li>
<li>there is an alternative to this that doesn’t print out anything or plot anything. It just <strong>AnnualResults &lt;- setupYearsKalmanFlux()</strong>
</li>
<li>the tables and graphs you will probably want can all be made from the content of Annual Results, and the meta data are all in the <strong>INFO</strong> object in the <strong>eList</strong>
</li>
<li>if the iterest is in only one season of the year then modify the call to <strong>computeAnnual</strong> by adding the <strong>paStart</strong> and <strong>paLong</strong> arguments for the season you are interested in.</li>
<li>note that <strong>AnnualResults</strong> has two attributes that tell the <strong>paStart</strong> and <strong>paLong</strong>, so you can always tell what you used as your period of analysis</li>
</ul>
</div>
<div id="how-the-code-handles-two-kinds-of-special-situations" class="section level1">
<h1 class="hasAnchor">
<a href="#how-the-code-handles-two-kinds-of-special-situations" class="anchor"></a>How the code handles two kinds of special situations</h1>
<p>The description in the two publications mentioned here accurately describes how the computations work in the situation where no days in the record have more than one observed value and where no censored data exist in the record. The following section describes how the code handles data sets that violate one or both of these constraints. You don’t really have to understand this to use the software, but for completeness we are describing how these situations are handled in the code.</p>
<div id="censored-data-less-than-values" class="section level2">
<h2 class="hasAnchor">
<a href="#censored-data-less-than-values" class="anchor"></a>Censored data (less than values)</h2>
<p>In order to fill in estimates for all the days with no samples, we must have a known value on each of the sampled days. We use this known value to compute a residual on the sampled day. These known residuals on either side of a data gap are what initialize the AR(1) process that fills in all the missing values of residuals in the gap. It would be incorrect to set these censored values with the reporting limit (<strong>ConcHigh</strong>) and also incorrect to set these censored values to half the reporting limit (this would be <strong>ConcAve</strong>). The solution is this. Since we are estimating the entire time series of residuals using Monte Carlo simulation we can also use Monte Carlo methods to create an appropriate value for the sampled day. For each replicate of the whole time series we will generate random values for each of the censored sample days. We already have a function that allows us to generate these random realizations of the censored day concentration. It is the function in EGRET called <strong>makeAugmentedSample</strong>. What it does is that on each day with a censored value it defines a truncated log normal distribution and takes a random sample from that distribution to represent the unknown true value on that day. The truncated lognormal distribution is defined by the WRTDS model for that day. It uses estimates of the conditional mean of the log concentration and the conditional standard deviation of the log concentration and assumes that the conditional distribution of the logs is normal. The distribution is not the whole normal distribution, rather it is made up of the left hand tail of the distribution. The truncation point is at the log of the reporting limit for the data value. What this means is that for the censored day, we can create a Monte Carlo sample value of the log of concentration by sampling from that truncated normal distribution (which is specific to the conditions on that day). Note here that the random observation values generated here are NOT used to estimate the WRTDS model; that is done in the usual fashion using the censored sample information.</p>
<p>So now the data generation scheme is done in two phases for each iteration: First we fill in values for each of the censored days and these, combined with the uncensored values constitute the sample data set we will work from. Then we use the AR(1) process to fill in the missing days between all the sampled days. Then when we move on to the next iteration we start all over with estimating all the censored days again and then fill the gaps, etc.</p>
<p>When we plot these data sets using <strong>plotTimeSlice</strong>, when there are censored values they plot in the blue color and they are located on the vertical scale at the reporting limit (meaning that the true value lies somewhere at or below the blue dot).</p>
</div>
<div id="multiple-observations-on-a-day" class="section level2">
<h2 class="hasAnchor">
<a href="#multiple-observations-on-a-day" class="anchor"></a>Multiple observations on a day</h2>
<p>When a day has more than one observation (i.e. more than one sample value) the approach we use here is much the same as what we used in the censored value situation. What we need in order to generate the full WRTDS_K record is a set of unique values for the sampled days. So, for any day with two or more samples we will randomly pick one of them and use it as an end point for the adjacent gap periods. Then once we pick it we generate the values between the sampled days regardless of whether the sample value used is a unique value for that day or if it is randomly selected from the multiple values observed on that day. Then on the next iteration we randomly select the values for these multiply sampled days and proceed with the AR(1) process to fill in between the sampled days. In the plot produced by plotTimeSlice all of the observations are shown as red dots. Thus if there are multiple sample values on a given day they will plot along a vertical line situated on that day.</p>
</div>
<div id="an-example-with-both-special-issues" class="section level2">
<h2 class="hasAnchor">
<a href="#an-example-with-both-special-issues" class="anchor"></a>An example with both special issues</h2>
<div class="sourceCode" id="cb38"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">eList</span>, <span class="va">DailyK</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"test.RData"</span><span class="op">)</span> <span class="co"># the name of your EGRET workspace</span>
<span class="va">DailyK</span> <span class="op">&lt;-</span> <span class="fu">makeDailyK</span><span class="op">(</span><span class="va">eList</span><span class="op">)</span>
<span class="fu"><a href="../reference/plotTimeSlice.html">plotTimeSlice</a></span><span class="op">(</span><span class="va">eList</span>, <span class="va">DailyK</span>, start <span class="op">=</span> <span class="fl">2010.2</span>, end <span class="op">=</span> <span class="fl">2010.4</span><span class="op">)</span></pre></div>
<p><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-8-1.png" width="700"><img src="Making%20WRTDS_K%20flux%20estimates_files/figure-html/unnamed-chunk-8-2.png" width="700"></p>
<p>If we look at the concentration graph we see two things of interest here. Right after 2010.30 there appear to be three days with censored values with a reporting limit at 0.004 mg/L. What is interesting here is that generally the green line (WRTDS_K estimates) go right through the samples (the red dots), here they don’t. That is because in the Monte Carlo simulation to “true” samples generated are always less than the reporting limit (the blue dots) so the green line lies below these points. Also, there is a case at around 2010.38 where there are two data points (red points) that lie one directly above the other. These are two sample values from the same day. The WRTDS_K estimate (green line) goes right between these two sample values because in the Monte Carlo simulation sometimes the sample value is the lower one and sometimes it is the upper one and the result is that the estimate lies between the two.</p>
</div>
</div>
<div id="final-thoughts" class="section level1">
<h1 class="hasAnchor">
<a href="#final-thoughts" class="anchor"></a>Final thoughts</h1>
<p>In a few months we expect to better integrate these WRTDS_K computations into EGRET for a new release of EGRET, but for now (December 2019) this is the way it should be implemented. Feedback is welcome before we more fully integrate it. The citations for the two papers that introduce and experiment with WRTDS_K are as follows.</p>
<p>Lee, C.J., Hirsch, R.M., and Crawford, C.G., 2019, An evaluation of methods for computing annual water-quality loads: U.S. Geological Survey Scientific Investigations Report 2019–5084, 59 p., <a href="https://doi.org/10.3133/sir20195084" class="uri">https://doi.org/10.3133/sir20195084</a>.</p>
<p>Zhang, Q. and Hirsch, R.M., 2019. River water‐quality concentration and flux estimation can be improved by accounting for serial correlation through an autoregressive model. Water Resources Research. <a href="https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2019WR025338" class="uri">https://agupubs.onlinelibrary.wiley.com/doi/epdf/10.1029/2019WR025338</a></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Robert Hirsch, Laura DeCicco.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
